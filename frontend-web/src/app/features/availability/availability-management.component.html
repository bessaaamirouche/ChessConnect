<div class="availability-page">
    <header class="page-header">
      <div>
        <h1 class="page-header__title">{{ 'availability.title' | translate }}</h1>
        <p class="page-header__subtitle">{{ 'availability.subtitle' | translate }}</p>
      </div>
      <button class="btn btn--primary" (click)="openAddModal()">
        <ng-icon name="heroPlus" size="16"></ng-icon> {{ 'availability.addSlot' | translate }}
      </button>
    </header>

    <div class="alert-inline-container">
      <div class="alert-inline alert-inline--error" [class.alert-inline--visible]="error()">
        <span>{{ error() }}</span>
      </div>
    </div>

    @if (loading()) {
      <div class="loading-state">
        <span class="spinner spinner--lg"></span>
        <p>{{ 'common.loading' | translate }}</p>
      </div>
    } @else {
      <!-- Recurring Availabilities -->
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'availability.recurring.title' | translate }}</h2>
        </div>
        <p class="section__desc">{{ 'availability.recurring.description' | translate }}</p>

        <div class="week-grid">
          @for (day of daysOfWeek; track day.value) {
            <div class="day-column">
              <div class="day-header">{{ day.label }}</div>
              <div class="day-slots">
                @for (slot of getAvailabilitiesByDay(day.value); track slot.id) {
                  <div class="slot-card">
                    <div class="slot-info">
                      <div class="slot-time">
                        {{ slot.startTime }} - {{ slot.endTime }}
                      </div>
                      <span class="slot-type-badge" [class.slot-type-badge--group]="slot.lessonType === 'GROUP'">
                        {{ slot.lessonType === 'GROUP' ? ('availability.lessonType.group' | translate) : ('availability.lessonType.individual' | translate) }}
                      </span>
                    </div>
                    <button class="slot-delete" (click)="deleteAvailability(slot.id)" [title]="'availability.slot.delete' | translate">
                      <ng-icon name="heroTrash" size="14"></ng-icon>
                    </button>
                  </div>
                } @empty {
                  <div class="no-slots">-</div>
                }
              </div>
            </div>
          }
        </div>
      </section>

      <!-- Specific Date Availabilities -->
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'availability.specific.title' | translate }}</h2>
        </div>
        <p class="section__desc">{{ 'availability.specific.description' | translate }}</p>

        @if (getSpecificDateAvailabilities().length > 0) {
          <!-- Filters -->
          <div class="specific-filters">
            <select class="input input--sm" [ngModel]="filterDate()" (ngModelChange)="filterDate.set($event)">
              <option value="">{{ 'availability.filter.allDates' | translate }}</option>
              @for (date of specificDates(); track date) {
                <option [value]="date">{{ date }}</option>
              }
            </select>
            <select class="input input--sm" [ngModel]="filterType()" (ngModelChange)="filterType.set($event)">
              <option value="">{{ 'availability.filter.allTypes' | translate }}</option>
              <option value="INDIVIDUAL">{{ 'availability.lessonType.individual' | translate }}</option>
              <option value="GROUP">{{ 'availability.lessonType.group' | translate }}</option>
            </select>
          </div>

          @if (groupedSpecificSlots().length > 0) {
            <div class="date-groups">
              @for (group of groupedSpecificSlots(); track group.date) {
                <div class="date-group">
                  <div class="date-group__header">
                    <ng-icon name="heroCalendarDays" size="14"></ng-icon>
                    <span>{{ group.date }}</span>
                  </div>
                  <div class="date-group__slots">
                    @for (slot of group.slots; track slot.id) {
                      <div class="date-slot">
                        <span class="date-slot__time">{{ slot.startTime }} - {{ slot.endTime }}</span>
                        <span class="slot-type-badge" [class.slot-type-badge--group]="slot.lessonType === 'GROUP'">
                          {{ slot.lessonType === 'GROUP' ? ('availability.lessonType.group' | translate) : ('availability.lessonType.individual' | translate) }}
                        </span>
                        <button class="slot-delete" (click)="deleteAvailability(slot.id)" [title]="'availability.slot.delete' | translate">
                          <ng-icon name="heroTrash" size="14"></ng-icon>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state empty-state--sm">
              <p class="empty-state__description">{{ 'availability.filter.noResults' | translate }}</p>
            </div>
          }
        } @else {
          <div class="empty-state">
            <div class="empty-state__icon"><ng-icon name="heroCalendarDays" size="48"></ng-icon></div>
            <p class="empty-state__description">{{ 'availability.specific.empty' | translate }}</p>
          </div>
        }
      </section>
    }
</div>

<!-- Add Modal -->
@if (showAddModal) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3>{{ 'availability.modal.title' | translate }}</h3>
        <button class="modal__close" (click)="closeModal()"><ng-icon name="heroXMark" size="20"></ng-icon></button>
      </div>

      <div class="modal__body">
        <!-- Error Display -->
        <div class="alert-inline-container">
          <div class="alert-inline alert-inline--error" [class.alert-inline--visible]="error()">
            <span>{{ error() }}</span>
            <button class="alert__close" (click)="clearError()">Ã—</button>
          </div>
        </div>

        <!-- Lesson Type Selection -->
        <div class="form-group">
          <label class="form-group__label">{{ 'availability.lessonType.label' | translate }}</label>
          <div class="radio-group">
            <label class="radio-option">
              <input
                type="radio"
                name="lessonType"
                value="INDIVIDUAL"
                [(ngModel)]="lessonType"
              />
              <span>{{ 'availability.lessonType.individual' | translate }}</span>
            </label>
            <label class="radio-option">
              <input
                type="radio"
                name="lessonType"
                value="GROUP"
                [(ngModel)]="lessonType"
              />
              <span>{{ 'availability.lessonType.group' | translate }}</span>
            </label>
          </div>
        </div>

        <!-- Type Selection -->
        <div class="form-group">
          <label class="form-group__label">{{ 'availability.slot.type' | translate }}</label>
          <div class="radio-group">
            <label class="radio-option">
              <input
                type="radio"
                name="recurring"
                [value]="true"
                [(ngModel)]="isRecurring"
                (ngModelChange)="onRecurringChange()"
              />
              <span>{{ 'availability.slot.recurringWeekly' | translate }}</span>
            </label>
            <label class="radio-option">
              <input
                type="radio"
                name="recurring"
                [value]="false"
                [(ngModel)]="isRecurring"
                (ngModelChange)="onRecurringChange()"
              />
              <span>{{ 'availability.slot.specificDate' | translate }}</span>
            </label>
          </div>
        </div>

        <!-- Day Selection (for recurring) -->
        @if (isRecurring) {
          <div class="form-group">
            <label class="form-group__label" for="daySelect">{{ 'availability.slot.dayOfWeek' | translate }}</label>
            <select id="daySelect" class="input" [(ngModel)]="selectedDay">
              @for (day of daysOfWeek; track day.value) {
                <option [value]="day.value">{{ day.label }}</option>
              }
            </select>
          </div>
        }

        <!-- Date Selection (for specific) -->
        @if (!isRecurring) {
          <div class="form-group">
            <label class="form-group__label" for="dateInput">{{ 'availability.slot.date' | translate }}</label>
            <app-date-input
              [(ngModel)]="selectedDate"
              [min]="getTodayDate()"
              [max]="getMaxDate()"
            ></app-date-input>
          </div>
        }

        <!-- Time Selection -->
        <div class="form-group">
          <label class="form-group__label">{{ 'availability.slot.startTime' | translate }}</label>
          <div class="time-picker">
            <select class="input time-picker__select" [(ngModel)]="startHour">
              @for (h of availableStartHours; track h) {
                <option [value]="h">{{ h }}</option>
              }
            </select>
            <span class="time-picker__separator">:</span>
            <select class="input time-picker__select" [(ngModel)]="startMinute">
              @for (m of minutes; track m) {
                <option [value]="m">{{ m }}</option>
              }
            </select>
          </div>
          <small class="form-hint">{{ 'availability.slot.durationHint' | translate }} {{ endTime }})</small>
        </div>
      </div>

      <div class="modal__footer">
        <button class="btn btn--ghost" (click)="closeModal()">{{ 'availability.modal.cancel' | translate }}</button>
        <button
          class="btn btn--primary"
          (click)="createAvailability()"
          [disabled]="!isFormValid() || submitting"
        >
          @if (submitting) {
            <span class="spinner spinner--sm"></span>
          } @else {
            {{ 'availability.modal.add' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Confirm Dialog -->
<app-confirm-dialog #confirmDialog></app-confirm-dialog>
