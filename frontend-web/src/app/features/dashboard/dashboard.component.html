<div class="dashboard">
  <!-- Mobile Header -->
  <header class="mobile-header">
    <a routerLink="/" class="mobile-header__logo">
      <img src="assets/logo.png" alt="mychess" class="mobile-header__logo-img">
    </a>
    <button class="mobile-header__hamburger" [class.active]="mobileMenuOpen()" (click)="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" [class.active]="mobileMenuOpen()" (click)="closeMobileMenu()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" [class.active]="mobileMenuOpen()">
    <div class="sidebar__header">
      <a routerLink="/" class="sidebar__logo">
        <img src="assets/logo.png" alt="mychess" class="sidebar__logo-img">
      </a>
      @if (authService.isStudent()) {
        <span class="sidebar__badge sidebar__badge--student">Eleve</span>
      } @else if (authService.isTeacher()) {
        <span class="sidebar__badge sidebar__badge--teacher">Professeur</span>
      }
      <button class="sidebar__close" (click)="closeMobileMenu()">✕</button>
    </div>

    <nav class="sidebar__nav">
      <div class="sidebar__section">
        <span class="sidebar__section-title">Menu</span>
        <button class="sidebar__link" [class.active]="activeView() === 'dashboard'" (click)="showDashboard(); closeMobileMenu()">
          <ng-icon name="heroChartBarSquare" class="sidebar__icon"></ng-icon> Mon Espace
        </button>
        <a routerLink="/lessons" class="sidebar__link" (click)="closeMobileMenu()">
          <ng-icon name="heroCalendarDays" class="sidebar__icon"></ng-icon> Mes Cours
        </a>
        @if (authService.isTeacher()) {
          <a routerLink="/availability" class="sidebar__link" (click)="closeMobileMenu()">
            <ng-icon name="heroClipboardDocumentList" class="sidebar__icon"></ng-icon> Mes Disponibilités
          </a>
        }
        @if (authService.isStudent()) {
          <a routerLink="/progress" class="sidebar__link" (click)="closeMobileMenu()">
            <ng-icon name="heroTrophy" class="sidebar__icon"></ng-icon> Ma Progression
          </a>
          <a routerLink="/subscription" class="sidebar__link" (click)="closeMobileMenu()">
            <ng-icon name="heroCreditCard" class="sidebar__icon"></ng-icon> Abonnement
          </a>
          <a routerLink="/teachers" class="sidebar__link" (click)="closeMobileMenu()">
            <ng-icon name="heroAcademicCap" class="sidebar__icon"></ng-icon> Trouver un Prof
          </a>
        }
      </div>

      <div class="sidebar__section">
        <span class="sidebar__section-title">Compte</span>
        <a routerLink="/settings" class="sidebar__link" (click)="closeMobileMenu()">
          <ng-icon name="heroUserCircle" class="sidebar__icon"></ng-icon> Mon Profil
        </a>
        <button class="sidebar__link" (click)="logout(); closeMobileMenu()">
          <ng-icon name="heroArrowRightOnRectangle" class="sidebar__icon"></ng-icon> Déconnexion
        </button>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    @if (activeView() === 'dashboard') {
      <header class="page-header">
        <div>
          <h1 class="page-header__title page-header__title--sm">
            Bonjour, {{ authService.currentUser()?.firstName }}
          </h1>
          <p class="page-header__subtitle">
            @if (authService.isStudent()) {
              Continuez votre progression aux échecs
            } @else {
              Gérez vos cours et suivez vos revenus
            }
          </p>
        </div>
      </header>

      <!-- Stats -->
    <section class="section">
      <div class="stats-grid">
        <div class="stats-card">
          <div class="stats-card__icon"><ng-icon name="heroCalendarDays" size="20"></ng-icon></div>
          <div class="stats-card__value">{{ lessonService.upcomingCount() }}</div>
          <div class="stats-card__label">Cours à venir</div>
        </div>
        <div class="stats-card">
          <div class="stats-card__icon"><ng-icon name="heroCheckCircle" size="20"></ng-icon></div>
          <div class="stats-card__value">{{ lessonService.completedCount() }}</div>
          <div class="stats-card__label">Cours terminés</div>
        </div>
        @if (authService.isStudent()) {
          @if (paymentService.activeSubscription()) {
            <a routerLink="/subscription" class="stats-card stats-card--link stats-card--gold">
              <div class="stats-card__icon"><ng-icon name="heroTicket" size="20"></ng-icon></div>
              <div class="stats-card__value">{{ paymentService.activeSubscription()!.remainingLessons }}/{{ paymentService.activeSubscription()!.monthlyQuota }}</div>
              <div class="stats-card__label">Cours restants</div>
            </a>
          } @else {
            <a routerLink="/subscription" class="stats-card stats-card--link">
              <div class="stats-card__icon"><ng-icon name="heroCreditCard" size="20"></ng-icon></div>
              <div class="stats-card__value">-</div>
              <div class="stats-card__label">Pas d'abonnement</div>
            </a>
          }
          <a routerLink="/progress" class="stats-card stats-card--link">
            <div class="stats-card__icon"><ng-icon name="heroTrophy" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ progressService.currentLevelInfo()?.label || '-' }}</div>
            <div class="stats-card__label">Niveau actuel</div>
          </a>
        } @else {
          <div class="stats-card stats-card--success">
            <div class="stats-card__icon"><ng-icon name="heroBanknotes" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ teacherService.balance()?.availableBalanceCents ? (teacherService.balance()!.availableBalanceCents / 100 | number:'1.2-2') + '€' : '0€' }}</div>
            <div class="stats-card__label">Solde disponible</div>
          </div>
          <div class="stats-card">
            <div class="stats-card__icon"><ng-icon name="heroArrowTrendingUp" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ teacherService.balance()?.totalEarnedCents ? (teacherService.balance()!.totalEarnedCents / 100 | number:'1.0-0') + '€' : '0€' }}</div>
            <div class="stats-card__label">Total gagné</div>
          </div>
        }
      </div>
    </section>

    <!-- Subscription Status for Students -->
    @if (authService.isStudent() && paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Mon abonnement</h2>
          <a routerLink="/subscription" class="btn btn--ghost btn--sm">Gerer</a>
        </div>
        <div class="subscription-status-card">
          <div class="subscription-status-card__badge subscription-status-card__badge--active">
            Actif
          </div>
          <div class="subscription-status-card__content">
            <div class="subscription-status-card__plan">
              <span class="subscription-status-card__plan-icon"><ng-icon name="heroTrophy" size="24"></ng-icon></span>
              <div>
                <h3>{{ paymentService.activeSubscription()!.planName || paymentService.activeSubscription()!.planType }}</h3>
                <p class="subscription-status-card__price">
                  {{ formatPrice(paymentService.activeSubscription()!.priceCents) }}/mois
                </p>
              </div>
            </div>
            <div class="subscription-status-card__details">
              <div class="subscription-status-card__detail">
                <span class="subscription-status-card__detail-label">Cours utilises</span>
                <span class="subscription-status-card__detail-value">
                  {{ paymentService.activeSubscription()!.lessonsUsedThisMonth }} / {{ paymentService.activeSubscription()!.monthlyQuota }}
                </span>
              </div>
              <div class="subscription-status-card__detail">
                <span class="subscription-status-card__detail-label">Debut</span>
                <span class="subscription-status-card__detail-value">
                  {{ paymentService.activeSubscription()!.startDate | date:'dd/MM/yyyy' }}
                </span>
              </div>
              <div class="subscription-status-card__detail">
                <span class="subscription-status-card__detail-label">Renouvellement</span>
                <span class="subscription-status-card__detail-value">
                  {{ getNextRenewalDate() | date:'dd/MM/yyyy' }}
                </span>
              </div>
            </div>
            <div class="subscription-status-card__info">
              <span class="subscription-status-card__info-icon"><ng-icon name="heroCheck" size="18"></ng-icon></span>
              <span>Reservez chez les profs acceptant les abonnements sans payer</span>
            </div>
          </div>
        </div>
      </section>
    }

    <!-- Teacher Earnings Section -->
    @if (authService.isTeacher()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Mes revenus</h2>
        </div>
        <div class="card">
          <div class="earnings-grid">
            <div class="earnings-item">
              <span class="earnings-item__label">Solde disponible</span>
              <span class="earnings-item__value text-success">
                {{ teacherService.balance()?.availableBalanceCents ? (teacherService.balance()!.availableBalanceCents / 100 | number:'1.2-2') : '0.00' }}€
              </span>
            </div>
            <div class="earnings-item">
              <span class="earnings-item__label">Total gagné</span>
              <span class="earnings-item__value">
                {{ teacherService.balance()?.totalEarnedCents ? (teacherService.balance()!.totalEarnedCents / 100 | number:'1.2-2') : '0.00' }}€
              </span>
            </div>
            <div class="earnings-item">
              <span class="earnings-item__label">Cours complétés</span>
              <span class="earnings-item__value">
                {{ teacherService.balance()?.lessonsCompleted || 0 }}
              </span>
            </div>
            <div class="earnings-item">
              <span class="earnings-item__label">Total retiré</span>
              <span class="earnings-item__value">
                {{ teacherService.balance()?.totalWithdrawnCents ? (teacherService.balance()!.totalWithdrawnCents / 100 | number:'1.2-2') : '0.00' }}€
              </span>
            </div>
          </div>
          @if (teacherService.balance()?.availableBalanceCents && teacherService.balance()!.availableBalanceCents > 0) {
            <div class="earnings-info">
              <span class="earnings-info__icon"><ng-icon name="heroInformationCircle" size="18"></ng-icon></span>
              <span>Le retrait de vos gains sera disponible prochainement.</span>
            </div>
          }
        </div>
      </section>
    }

    <!-- Upcoming Lessons -->
    <section class="section">
      <div class="section__header">
        <h2 class="section__title">Prochains cours</h2>
        @if (authService.isStudent()) {
          <a routerLink="/teachers" class="btn btn--primary btn--sm">Réserver un cours</a>
        }
      </div>

      @if (lessonService.loading()) {
        <div class="loading-state">
          <span class="spinner spinner--lg"></span>
        </div>
      } @else if (lessonService.upcomingLessons().length === 0) {
        <div class="empty-state">
          <div class="empty-state__icon"><ng-icon name="heroCalendarDays" size="48"></ng-icon></div>
          <h3 class="empty-state__title">Aucun cours prévu</h3>
          <p class="empty-state__description">
            @if (authService.isStudent()) {
              Trouvez un professeur et réservez votre premier cours !
            } @else {
              Vos prochains cours apparaîtront ici
            }
          </p>
          @if (authService.isStudent()) {
            <a routerLink="/teachers" class="btn btn--primary">Trouver un professeur</a>
          }
        </div>
      } @else {
        <div class="lessons-list">
          @for (lesson of lessonService.upcomingLessons(); track lesson.id) {
            <div class="lesson-card">
              <div class="lesson-card__time">
                <span class="lesson-card__time-day">
                  {{ lesson.scheduledAt | date:'EEE' }}
                </span>
                <span class="lesson-card__time-date">
                  {{ lesson.scheduledAt | date:'dd' }}
                </span>
                <span class="lesson-card__time-hour">
                  {{ lesson.scheduledAt | date:'HH:mm' }}
                </span>
              </div>
              <div class="lesson-card__content">
                <h4>
                  @if (authService.isStudent()) {
                    Cours avec {{ lesson.teacherName }}
                  } @else {
                    Cours avec {{ lesson.studentName }}
                  }
                </h4>
                <span class="badge" [class]="statusLabels[lesson.status].cssClass">
                  {{ statusLabels[lesson.status].label }}
                </span>
                @if (lesson.isFromSubscription) {
                  <span class="badge badge--gold">Abonnement</span>
                }
              </div>
              <div class="lesson-card__actions">
                @if (authService.isTeacher() && lesson.status === 'PENDING') {
                  <button class="btn btn--primary btn--sm" (click)="confirmLesson(lesson.id)">
                    Confirmer
                  </button>
                  <button class="btn btn--ghost btn--sm" (click)="cancelLesson(lesson.id)">
                    Refuser
                  </button>
                }
                @if (lesson.status === 'CONFIRMED' && lesson.zoomLink) {
                  @if (canJoinLesson(lesson)) {
                    <a [href]="lesson.zoomLink" target="_blank" class="btn btn--primary btn--sm">
                      Accéder
                    </a>
                  } @else {
                    <span class="time-badge">{{ getTimeUntilJoin(lesson) }}</span>
                  }
                }
                @if (authService.isTeacher() && lesson.status === 'CONFIRMED') {
                  <button class="btn btn--ghost btn--sm" (click)="completeLesson(lesson.id)">
                    Terminer
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>
    } @else {
      <!-- Profile View -->
      <header class="page-header">
        <div>
          <h1 class="page-header__title">Mon profil</h1>
          <p class="page-header__subtitle">Gérez vos informations et vos paramètres</p>
        </div>
      </header>

      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Informations personnelles</h2>
        </div>

        @if (profileSuccess()) {
          <div class="alert alert--success">Profil mis à jour avec succès !</div>
        }
        @if (profileError()) {
          <div class="alert alert--error">{{ profileError() }}</div>
        }

        <div class="card">
          <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-group__label">Prénom</label>
                <input type="text" formControlName="firstName" class="input">
              </div>
              <div class="form-group">
                <label class="form-group__label">Nom</label>
                <input type="text" formControlName="lastName" class="input">
              </div>
            </div>

            <div class="form-group">
              <label class="form-group__label">Tarif horaire</label>
              <div class="input-group">
                <input type="number" formControlName="hourlyRate" class="input" min="10" step="5">
                <span class="input-group__addon">€/h</span>
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox">
                <input type="checkbox" formControlName="acceptsSubscription">
                <span>J'accepte les élèves avec abonnement</span>
              </label>
            </div>

            <div class="form-group">
              <label class="form-group__label">Bio</label>
              <textarea
                formControlName="bio"
                class="textarea"
                rows="4"
                placeholder="Décrivez votre expérience et votre approche pédagogique..."
              ></textarea>
            </div>

            <button type="submit" class="btn btn--primary" [disabled]="profileForm.invalid || savingProfile()">
              @if (savingProfile()) {
                <span class="spinner spinner--sm"></span>
                Enregistrement...
              } @else {
                Enregistrer les modifications
              }
            </button>
          </form>
        </div>
      </section>

      <!-- Password Section -->
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Changer le mot de passe</h2>
        </div>

        @if (passwordSuccess()) {
          <div class="alert alert--success">Mot de passe modifié avec succès !</div>
        }
        @if (passwordError()) {
          <div class="alert alert--error">{{ passwordError() }}</div>
        }

        <div class="card">
          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="profile-form">
            <div class="form-group">
              <label class="form-group__label">Mot de passe actuel</label>
              <input type="password" formControlName="currentPassword" class="input">
            </div>
            <div class="form-group">
              <label class="form-group__label">Nouveau mot de passe</label>
              <input type="password" formControlName="newPassword" class="input">
            </div>
            <div class="form-group">
              <label class="form-group__label">Confirmer le nouveau mot de passe</label>
              <input type="password" formControlName="confirmPassword" class="input">
            </div>

            <button type="submit" class="btn btn--ghost" [disabled]="passwordForm.invalid || savingPassword()">
              @if (savingPassword()) {
                <span class="spinner spinner--sm"></span>
                Modification...
              } @else {
                Changer le mot de passe
              }
            </button>
          </form>
        </div>
      </section>
    }
  </main>

  <!-- Settings Panel -->
  @if (showSettings()) {
    <div class="settings-overlay" (click)="closeSettings()"></div>
    <aside class="settings-panel">
      <div class="settings-panel__header">
        <h2>Parametres</h2>
        <button class="settings-panel__close" (click)="closeSettings()">✕</button>
      </div>

      <div class="settings-panel__content">
        <!-- Profile Section -->
        <section class="settings-section">
          <h3>Informations du profil</h3>

          @if (settingsSuccess()) {
            <div class="alert alert--success">Profil mis a jour !</div>
          }
          @if (settingsError()) {
            <div class="alert alert--error">{{ settingsError() }}</div>
          }

          <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
            <div class="settings-form-row">
              <div class="form-group">
                <label class="form-group__label">Prenom</label>
                <input type="text" formControlName="firstName" class="input">
              </div>
              <div class="form-group">
                <label class="form-group__label">Nom</label>
                <input type="text" formControlName="lastName" class="input">
              </div>
            </div>

            @if (authService.isTeacher()) {
              <div class="form-group">
                <label class="form-group__label">Tarif horaire (EUR)</label>
                <div class="input-group">
                  <input type="number" formControlName="hourlyRate" class="input" min="10" step="5">
                  <span class="input-group__addon">EUR/h</span>
                </div>
              </div>

              <div class="form-group">
                <label class="checkbox">
                  <input type="checkbox" formControlName="acceptsSubscription">
                  <span>J'accepte les eleves avec abonnement</span>
                </label>
              </div>

              <div class="form-group">
                <label class="form-group__label">Bio</label>
                <textarea formControlName="bio" class="textarea" rows="3" placeholder="Votre experience..."></textarea>
              </div>
            }

            <button type="submit" class="btn btn--primary btn--block" [disabled]="settingsForm.invalid || savingSettings()">
              @if (savingSettings()) {
                <span class="spinner spinner--sm"></span> Enregistrement...
              } @else {
                Enregistrer
              }
            </button>
          </form>
        </section>

        <!-- Password Section -->
        <section class="settings-section">
          <h3>Changer le mot de passe</h3>

          @if (passwordSuccess()) {
            <div class="alert alert--success">Mot de passe modifie !</div>
          }
          @if (passwordError()) {
            <div class="alert alert--error">{{ passwordError() }}</div>
          }

          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <div class="form-group">
              <label class="form-group__label">Mot de passe actuel</label>
              <input type="password" formControlName="currentPassword" class="input">
            </div>
            <div class="form-group">
              <label class="form-group__label">Nouveau mot de passe</label>
              <input type="password" formControlName="newPassword" class="input">
            </div>
            <div class="form-group">
              <label class="form-group__label">Confirmer</label>
              <input type="password" formControlName="confirmPassword" class="input">
            </div>

            <button type="submit" class="btn btn--ghost btn--block" [disabled]="passwordForm.invalid || savingPassword()">
              @if (savingPassword()) {
                <span class="spinner spinner--sm"></span> Modification...
              } @else {
                Changer le mot de passe
              }
            </button>
          </form>
        </section>
      </div>
    </aside>
  }

  <!-- Confirm Modal -->
  <app-confirm-modal #confirmModal></app-confirm-modal>
</div>
