<div class="dashboard">
  <!-- Main Content -->
  <header class="page-header">
        <div>
          <h1 class="page-header__title page-header__title--sm">
            {{ 'dashboard.hello' | translate }}, {{ authService.currentUser()?.firstName }}
          </h1>
          <p class="page-header__subtitle">
            @if (authService.isStudent()) {
              {{ 'dashboard.continueProgress' | translate }}
            } @else {
              {{ 'dashboard.manageCoursesRevenue' | translate }}
            }
          </p>
        </div>
      </header>

      <!-- Stats -->
    <section class="section">
      <div class="stats-grid">
        <div class="stats-card">
          <div class="stats-card__icon"><ng-icon name="heroCalendarDays" size="20"></ng-icon></div>
          <div class="stats-card__value">{{ lessonService.upcomingCount() }}</div>
          <div class="stats-card__label">{{ 'dashboard.stats.upcomingLessons' | translate }}</div>
        </div>
        <div class="stats-card">
          <div class="stats-card__icon"><ng-icon name="heroCheckCircle" size="20"></ng-icon></div>
          <div class="stats-card__value">{{ authService.isTeacher() ? (teacherService.balance()?.lessonsCompleted || 0) : lessonService.completedCount() }}</div>
          <div class="stats-card__label">{{ 'dashboard.stats.completedLessons' | translate }}</div>
        </div>
        @if (authService.isStudent()) {
          @if (paymentService.activeSubscription()) {
            <a routerLink="/subscription" class="stats-card stats-card--link stats-card--gold">
              <div class="stats-card__icon"><ng-icon name="heroSparkles" size="20"></ng-icon></div>
              <div class="stats-card__value">{{ 'common.premium' | translate }}</div>
              <div class="stats-card__label">{{ 'dashboard.stats.activeSubscription' | translate }}</div>
            </a>
          } @else {
            <a routerLink="/subscription" class="stats-card stats-card--link">
              <div class="stats-card__icon"><ng-icon name="heroCreditCard" size="20"></ng-icon></div>
              <div class="stats-card__value">-</div>
              <div class="stats-card__label">{{ 'dashboard.stats.goPremium' | translate }}</div>
            </a>
          }
          <a routerLink="/progress" class="stats-card stats-card--link">
            <div class="stats-card__icon"><ng-icon name="heroTrophy" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ progressService.currentLevelInfo()?.label || '-' }}</div>
            <div class="stats-card__label">{{ 'dashboard.currentLevel' | translate }}</div>
          </a>
        } @else {
          <div class="stats-card stats-card--success">
            <div class="stats-card__icon"><ng-icon name="heroBanknotes" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ teacherService.balance()?.availableBalanceCents ? (teacherService.balance()!.availableBalanceCents / 100 | number:'1.2-2') + '€' : '0€' }}</div>
            <div class="stats-card__label">{{ 'dashboard.stats.availableBalance' | translate }}</div>
          </div>
          <div class="stats-card">
            <div class="stats-card__icon"><ng-icon name="heroArrowTrendingUp" size="20"></ng-icon></div>
            <div class="stats-card__value">{{ teacherService.balance()?.totalEarnedCents ? (teacherService.balance()!.totalEarnedCents / 100 | number:'1.2-2') + '€' : '0€' }}</div>
            <div class="stats-card__label">{{ 'dashboard.stats.totalEarned' | translate }}</div>
          </div>
        }
      </div>
    </section>

    <!-- Mes Gains for Teachers -->
    @if (authService.isTeacher()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'dashboard.earnings.title' | translate }}</h2>
          <a routerLink="/settings" class="btn btn--ghost btn--sm">{{ 'dashboard.earnings.configurePayments' | translate }}</a>
        </div>

        <div class="alert-inline-container">
          <div class="alert-inline" [class.alert-inline--visible]="withdrawSuccess() || withdrawError()" [class.alert-inline--success]="withdrawSuccess()" [class.alert-inline--error]="withdrawError()">
            <span>{{ withdrawSuccess() || withdrawError() }}</span>
          </div>
        </div>
        @if (!stripeConnectReady()) {
          <div class="alert alert--warning">
            <ng-icon name="heroExclamationTriangle" size="18"></ng-icon>
            <span>{{ 'dashboard.earnings.stripeWarning' | translate }} <a routerLink="/settings" class="link">{{ 'settings.profile.title' | translate }}</a></span>
          </div>
        }

        <div class="earnings-card">
          <p class="earnings-note">{{ 'dashboard.earnings.netAmountsNote' | translate }}</p>
          <div class="earnings-summary">
            <div class="earnings-item earnings-item--main">
              <span class="earnings-item__label">{{ 'dashboard.earnings.availableBalance' | translate }}</span>
              <span class="earnings-item__value">{{ formatCents(teacherService.balance()?.availableBalanceCents || 0) }}</span>
            </div>
            <div class="earnings-item">
              <span class="earnings-item__label">{{ 'dashboard.earnings.totalEarnedNet' | translate }}</span>
              <span class="earnings-item__value">{{ formatCents(teacherService.balance()?.totalEarnedCents || 0) }}</span>
            </div>
            <div class="earnings-item">
              <span class="earnings-item__label">{{ 'dashboard.earnings.alreadyWithdrawn' | translate }}</span>
              <span class="earnings-item__value">{{ formatCents(teacherService.balance()?.totalWithdrawnCents || 0) }}</span>
            </div>
          </div>

          @if (teacherService.balance() && teacherService.balance()!.availableBalanceCents >= 10000 && stripeConnectReady()) {
            <div class="withdraw-form">
              <div class="withdraw-input-group">
                <label class="form-label">{{ 'dashboard.earnings.amountToWithdraw' | translate }}</label>
                <div class="input-with-addon">
                  <input
                    type="number"
                    class="input"
                    [value]="withdrawAmount()"
                    (input)="setWithdrawAmount($event)"
                    [min]="100"
                    [max]="(teacherService.balance()!.availableBalanceCents / 100)"
                    step="1"
                    placeholder="100"
                  >
                  <span class="input-addon">EUR</span>
                </div>
                <small class="form-hint">{{ 'dashboard.earnings.minimumMaximum' | translate }} {{ formatCents(teacherService.balance()!.availableBalanceCents) }}</small>
              </div>
              <button
                class="btn btn--primary"
                (click)="withdrawEarnings()"
                [disabled]="withdrawing() || withdrawAmount() < 100 || withdrawAmount() * 100 > teacherService.balance()!.availableBalanceCents"
              >
                @if (withdrawing()) {
                  <span class="spinner"></span> {{ 'dashboard.earnings.withdrawalInProgress' | translate }}
                } @else {
                  {{ 'dashboard.earnings.withdraw' | translate }} {{ withdrawAmount() }} EUR
                }
              </button>
            </div>
          } @else if (teacherService.balance() && teacherService.balance()!.availableBalanceCents > 0 && teacherService.balance()!.availableBalanceCents < 10000 && stripeConnectReady()) {
            <p class="earnings-hint">{{ 'dashboard.earnings.minimumRequired' | translate }} {{ formatCents(10000 - teacherService.balance()!.availableBalanceCents) }}.</p>
          } @else if (teacherService.balance() && teacherService.balance()!.availableBalanceCents > 0 && !stripeConnectReady()) {
            <p class="earnings-hint">
              <a routerLink="/settings" class="link">{{ 'dashboard.earnings.configureBank' | translate }}</a>
            </p>
          } @else {
            <p class="earnings-hint">{{ 'dashboard.earnings.noEarningsYet' | translate }}</p>
          }
        </div>
      </section>
    }

    <!-- Wallet & Subscription for Students -->
    @if (authService.isStudent()) {
      <div class="student-sections">
        <!-- Wallet Section -->
        <section class="section wallet-section">
          <div class="section__header">
            <h2 class="section__title">{{ 'dashboard.wallet.title' | translate }}</h2>
            <a routerLink="/wallet" class="btn btn--ghost btn--sm">{{ 'dashboard.wallet.viewAll' | translate }}</a>
          </div>
          <div class="wallet-card">
            <div class="wallet-card__balance">
              <span class="wallet-card__balance-label">{{ 'dashboard.wallet.availableBalance' | translate }}</span>
              <span class="wallet-card__balance-value">{{ (walletService.balance() / 100) | number:'1.2-2' }} €</span>
            </div>
            <div class="wallet-card__actions">
              <a routerLink="/wallet" class="btn btn--primary btn--sm">{{ 'dashboard.wallet.credit' | translate }}</a>
              <a routerLink="/teachers" class="btn btn--secondary btn--sm">{{ 'dashboard.wallet.bookLesson' | translate }}</a>
            </div>
          </div>
        </section>

        <!-- Subscription Section -->
        <section class="section subscription-section">
          <div class="section__header">
            <h2 class="section__title">{{ 'dashboard.subscription.title' | translate }}</h2>
            <a routerLink="/subscription" class="btn btn--ghost btn--sm">{{ 'dashboard.subscription.manage' | translate }}</a>
          </div>
          @if (paymentService.activeSubscription()) {
            <div class="subscription-card subscription-card--active">
              <div class="subscription-card__badge">
                <ng-icon name="heroSparkles" size="14"></ng-icon> {{ 'dashboard.subscription.premium' | translate }}
              </div>
              <div class="subscription-card__content">
                <div class="subscription-card__price">{{ formatPrice(paymentService.activeSubscription()!.priceCents) }}/{{ 'common.perMonth' | translate }}</div>
                <div class="subscription-card__features">
                  <span><ng-icon name="heroCheck" size="14"></ng-icon> {{ 'dashboard.subscription.replay' | translate }}</span>
                  <span><ng-icon name="heroCheck" size="14"></ng-icon> {{ 'dashboard.subscription.notifications' | translate }}</span>
                </div>
                <div class="subscription-card__since">
                  {{ 'dashboard.subscription.since' | translate }} {{ paymentService.activeSubscription()!.startDate | date:'dd/MM/yyyy' }}
                </div>
              </div>
            </div>
          } @else {
            <div class="subscription-card subscription-card--inactive">
              <div class="subscription-card__content">
                <div class="subscription-card__title">{{ 'dashboard.subscription.goPremium' | translate }}</div>
                <div class="subscription-card__desc">{{ 'dashboard.subscription.accessReplays' | translate }}</div>
                <a routerLink="/subscription" class="btn btn--primary btn--sm">{{ 'dashboard.subscription.discover' | translate }}</a>
              </div>
            </div>
          }
        </section>
      </div>
    }

    <!-- Upcoming Lessons (Teachers only) -->
    @if (authService.isTeacher()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'dashboard.teacherLessons.title' | translate }}</h2>
        </div>

        @if (lessonService.loading()) {
          <div class="loading-state">
            <span class="spinner spinner--lg"></span>
          </div>
        } @else if (lessonService.upcomingLessons().length === 0) {
          <div class="empty-state">
            <div class="empty-state__icon"><ng-icon name="heroCalendarDays" size="48"></ng-icon></div>
            <h3 class="empty-state__title">{{ 'dashboard.noUpcoming' | translate }}</h3>
            <p class="empty-state__description">{{ 'dashboard.noUpcomingDescription' | translate }}</p>
          </div>
        } @else {
          <div class="lessons-list">
            @for (lesson of lessonService.upcomingLessons(); track lesson.id) {
              <div class="lesson-card">
                <div class="lesson-card__time">
                  <span class="lesson-card__time-day">{{ lesson.scheduledAt | date:'EEE' }}</span>
                  <span class="lesson-card__time-date">{{ lesson.scheduledAt | date:'dd' }}</span>
                  <span class="lesson-card__time-hour">{{ lesson.scheduledAt | date:'HH:mm' }}</span>
                </div>
                <div class="lesson-card__content">
                  <h4>{{ 'dashboard.teacherLessons.lessonWith' | translate }} {{ lesson.studentName }}</h4>
                  <span class="badge" [class]="statusLabels[lesson.status].cssClass">
                    {{ statusLabels[lesson.status].label }}
                  </span>
                </div>
                <div class="lesson-card__actions">
                  @if (lesson.status === 'PENDING') {
                    <button class="btn btn--primary btn--sm" (click)="confirmLesson(lesson.id)">{{ 'dashboard.teacherLessons.confirm' | translate }}</button>
                    <button class="btn btn--ghost btn--sm" (click)="cancelLesson(lesson.id)">{{ 'dashboard.teacherLessons.decline' | translate }}</button>
                  }
                  @if (lesson.status === 'CONFIRMED' && lesson.zoomLink) {
                    @if (canJoinLesson(lesson)) {
                      <a [href]="lesson.zoomLink" target="_blank" class="btn btn--primary btn--sm">{{ 'dashboard.teacherLessons.join' | translate }}</a>
                    } @else {
                      <span class="time-badge">{{ getTimeUntilJoin(lesson) }}</span>
                    }
                  }
                  @if (lesson.status === 'CONFIRMED') {
                    <button class="btn btn--ghost btn--sm" (click)="completeLesson(lesson.id)">{{ 'dashboard.teacherLessons.complete' | translate }}</button>
                  }
                </div>
              </div>
            }
          </div>
        }
      </section>
    }

  <!-- Confirm Dialog -->
  <app-confirm-dialog #confirmDialog></app-confirm-dialog>
</div>
