<div class="exercise-page">
  <header class="exercise-header">
    <button class="btn btn--ghost" (click)="goBack()">
      <ng-icon name="heroArrowLeft" size="20"></ng-icon>
      {{ 'exercise.back' | translate }}
    </button>

    @if (exercise()) {
      <div class="exercise-header__info">
        <h1>{{ exercise()!.courseTitle || (('exercise.trainingLevel' | translate) + ' ' + (exercise()!.chessLevel || ('exercise.difficulty.beginner' | translate))) }}</h1>
        <p class="lesson-meta">{{ 'exercise.botMode' | translate }} {{ difficultyLabels[exercise()!.difficultyLevel].labelKey | translate }}</p>
        <div class="exercise-badges">
          <span
            class="difficulty-badge"
            [style.background-color]="difficultyLabels[exercise()!.difficultyLevel].color + '20'"
            [style.color]="difficultyLabels[exercise()!.difficultyLevel].color"
          >
            <ng-icon name="heroCpuChip" size="14"></ng-icon>
            {{ difficultyLabels[exercise()!.difficultyLevel].labelKey | translate }}
          </span>
          @if (engineService.thinking()) {
            <span class="thinking-badge">
              <span class="thinking-dot"></span>
              {{ 'exercise.game.thinking' | translate }}
            </span>
          }
        </div>
      </div>
    }
  </header>

  <main class="exercise-content">
    @if (exerciseService.loading() || gameStatus() === 'loading') {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>{{ 'exercise.loading' | translate }}</p>
        @if (!engineInitialized()) {
          <p class="loading-hint">{{ 'exercise.initEngine' | translate }}</p>
        }
      </div>
    } @else if (exerciseService.error()) {
      <div class="error-state">
        <ng-icon name="heroExclamationTriangle" size="48"></ng-icon>
        <p>{{ exerciseService.error() }}</p>
        <button class="btn btn--primary" (click)="goBack()">{{ 'exercise.backToLessons' | translate }}</button>
      </div>
    } @else if (exercise()) {
      <div class="game-container">
        <!-- Chess Board -->
        <div class="board-section">
          <app-chess-board
            #chessBoard
            [fen]="exercise()!.startingFen"
            [orientation]="exercise()!.playerColor"
            [movable]="isPlayerTurn() && gameStatus() === 'playing'"
            [showControls]="true"
            (move)="onPlayerMove($event)"
            (reset)="onReset()"
            (resign)="onResign()"
          ></app-chess-board>
        </div>

        <!-- Game Info Panel -->
        <div class="info-panel">
          <!-- Game Status -->
          @if (gameStatus() !== 'playing' && gameStatus() !== 'loading') {
            <div
              class="game-result"
              [class.game-result--win]="gameStatus() === 'player_won'"
              [class.game-result--lose]="gameStatus() === 'ai_won'"
              [class.game-result--draw]="gameStatus() === 'draw'"
            >
              @if (gameStatus() === 'player_won') {
                <ng-icon name="heroTrophy" size="32"></ng-icon>
                <h2>{{ 'exercise.result.win' | translate }}</h2>
                <p>{{ 'exercise.result.winMessage' | translate }}</p>
              } @else if (gameStatus() === 'ai_won') {
                <ng-icon name="heroXCircle" size="32"></ng-icon>
                <h2>{{ 'exercise.result.lose' | translate }}</h2>
                <p>{{ 'exercise.result.loseMessage' | translate }}</p>
              } @else {
                <ng-icon name="heroExclamationTriangle" size="32"></ng-icon>
                <h2>{{ 'exercise.result.draw' | translate }}</h2>
                <p>{{ 'exercise.result.drawMessage' | translate }}</p>
              }
              <button class="btn btn--primary" (click)="onReset()">
                {{ 'exercise.result.playAgain' | translate }}
              </button>
            </div>
          }

          <!-- Turn Indicator -->
          @if (gameStatus() === 'playing') {
            <div class="turn-indicator">
              <div class="turn-indicator__dot" [class.turn-indicator__dot--active]="isPlayerTurn()"></div>
              <span>{{ isPlayerTurn() ? ('exercise.game.yourTurn' | translate) : ('exercise.game.botTurn' | translate) }}</span>
            </div>
          }

          <!-- Evaluation Bar -->
          @if (engineService.evaluation() !== null && gameStatus() === 'playing') {
            <div class="evaluation-section">
              <h3>{{ 'exercise.evaluation.title' | translate }}</h3>
              <div class="eval-bar">
                <div
                  class="eval-bar__fill"
                  [style.width.%]="getEvalBarWidth()"
                ></div>
              </div>
              <span class="eval-value">
                {{ formatEvaluation() }}
              </span>
            </div>
          }

          <!-- Move History -->
          <div class="history-section">
            <h3>
              <ng-icon name="heroClock" size="16"></ng-icon>
              {{ 'exercise.history.title' | translate }} ({{ moveCount() }} {{ 'exercise.history.moves' | translate }})
            </h3>
            <div class="move-list">
              @for (movePair of formatMoveHistory(); track movePair.moveNumber) {
                <div class="move-pair">
                  <span class="move-number">{{ movePair.moveNumber }}.</span>
                  <span class="move">{{ movePair.white }}</span>
                  @if (movePair.black) {
                    <span class="move">{{ movePair.black }}</span>
                  }
                </div>
              }
              @if (moveHistory().length === 0) {
                <p class="no-moves">{{ 'exercise.history.noMoves' | translate }}</p>
              }
            </div>
          </div>

          <!-- Tips -->
          @if (exercise()!.description) {
            <div class="tips-section">
              <h3>{{ 'exercise.tip' | translate }}</h3>
              <p>{{ exercise()!.description }}</p>
            </div>
          }
        </div>
      </div>
    }
  </main>
</div>
