<div class="lessons-page">
    <header class="page-header">
      <div>
        <div class="page-header__title-row">
          <h1 class="page-header__title">Mes Cours</h1>
          <div class="email-reminder-toggle">
            <label class="toggle toggle--sm" [class.toggle--loading]="savingEmailReminders()">
              <input
                type="checkbox"
                [checked]="emailRemindersEnabled()"
                (change)="toggleEmailReminders()"
                [disabled]="savingEmailReminders()"
              >
              <span class="toggle__slider"></span>
            </label>
            <span class="email-reminder-toggle__label">
              <ng-icon name="heroBellAlert" size="14"></ng-icon>
              rappels email
            </span>
          </div>
        </div>
        <p class="page-header__subtitle">Gérez vos leçons d'échecs</p>
      </div>
      @if (authService.isStudent()) {
        <a routerLink="/teachers" class="btn btn--primary">
          <ng-icon name="heroPlus" size="16"></ng-icon> Réserver un cours
        </a>
      }
    </header>

    <!-- Upcoming Lessons -->
    <section class="section">
      <div class="section__header">
        <h2 class="section__title">Cours à venir</h2>
      </div>
      <p class="section__desc">Vos prochaines leçons programmées</p>

      @if (lessonService.upcomingLessons().length === 0) {
        <div class="empty-state">
          <div class="empty-state__icon"><ng-icon name="heroCalendarDays" size="48"></ng-icon></div>
          <p class="empty-state__description">Aucun cours prévu</p>
        </div>
      } @else {
        <div class="lessons-list">
          @for (lesson of lessonService.upcomingLessons(); track lesson.id) {
            <div class="lesson-card">
              <div class="lesson-card__time">
                <span class="lesson-card__time-day">{{ lesson.scheduledAt | date:'EEE' }}</span>
                <span class="lesson-card__time-date">{{ lesson.scheduledAt | date:'d' }}</span>
                <span class="lesson-card__time-hour">{{ lesson.scheduledAt | date:'HH:mm' }}</span>
              </div>

              <div class="lesson-card__content">
                <h4>
                  @if (authService.isStudent()) {
                    Cours avec {{ lesson.teacherName }}
                  } @else {
                    <span class="lesson-card__student">
                      Cours avec {{ lesson.studentName }}
                      <button
                        class="btn-link"
                        (click)="openStudentProfile(lesson.studentId)"
                        title="Voir le coachil"
                      >
                        <ng-icon name="heroUserCircle" size="18"></ng-icon>
                      </button>
                    </span>
                  }
                </h4>
                @if (authService.isTeacher()) {
                  <div class="lesson-card__student-info">
                    @if (lesson.studentLevel) {
                      <span class="student-info-badge">
                        <ng-icon name="heroTrophy" size="14"></ng-icon>
                        {{ getLevelLabel(lesson.studentLevel) }}
                      </span>
                    }
                    @if (lesson.studentAge) {
                      <span class="student-info-badge">
                        <ng-icon name="heroUser" size="14"></ng-icon>
                        {{ lesson.studentAge }} ans
                      </span>
                    }
                    @if (lesson.studentElo) {
                      <span class="student-info-badge">
                        <ng-icon name="heroChartBar" size="14"></ng-icon>
                        ELO {{ lesson.studentElo }}
                      </span>
                    }
                    @if (lesson.courseTitle) {
                      <span class="next-course-label">Cours : {{ lesson.courseTitle }}</span>
                    } @else if (lesson.status === 'PENDING') {
                      @if (getNextCourse(lesson.studentId); as nextCourse) {
                        <span class="next-course-label">Prochain cours : {{ nextCourse.title }}</span>
                      }
                    }
                  </div>
                }
                <div class="lesson-card__meta">
                  <span class="badge" [class]="statusLabels[lesson.status].cssClass">
                    {{ getStatusLabel(lesson) }}
                  </span>
                  @if (lesson.isFromSubscription) {
                    <span class="badge badge--gold">Abo</span>
                  }
                  @if (lesson.isFreeTrial) {
                    <span class="badge badge--info" title="Cours decouverte gratuit - 15 min (non remunere)">Decouverte</span>
                  }
                </div>
              </div>

              <div class="lesson-card__actions">
                @if (lesson.status === 'PENDING' && authService.isTeacher()) {
                  <button class="btn btn--primary btn--sm" (click)="confirmLesson(lesson.id)">
                    Confirmer
                  </button>
                }
                @if (lesson.status === 'CONFIRMED' && lesson.zoomLink) {
                  @if (canJoinLesson(lesson)) {
                    <button class="btn btn--primary btn--sm" (click)="openVideoCall(lesson)">
                      Accéder
                    </button>
                  } @else {
                    <span class="time-badge">{{ getTimeUntilJoin(lesson) }}</span>
                  }
                }
                @if (lesson.status === 'CONFIRMED' && authService.isTeacher() && canCompleteLesson(lesson)) {
                  <button class="btn btn--secondary btn--sm" (click)="openCompleteModal(lesson.id)">
                    Terminer
                  </button>
                }
                @if (lesson.status !== 'CANCELLED' && lesson.status !== 'COMPLETED') {
                  <button class="btn btn--ghost btn--sm" (click)="cancelLesson(lesson.id)">
                    Annuler
                  </button>
                }
                @if (lesson.status === 'CANCELLED') {
                  @if (lesson.cancellationReason) {
                    <button
                      class="btn btn--ghost btn--sm"
                      (click)="toggleReason(lesson.id)"
                      title="Voir la raison"
                    >
                      <ng-icon name="heroInformationCircle" size="16"></ng-icon>
                    </button>
                  }
                  <button class="btn btn--ghost btn--sm" (click)="deleteLesson(lesson.id)">
                    <ng-icon name="heroTrash" size="16"></ng-icon>
                  </button>
                }
              </div>
            </div>
            @if (lesson.status === 'CANCELLED' && lesson.cancellationReason && visibleReasonId() === lesson.id) {
              <div class="reason-banner">
                <ng-icon name="heroInformationCircle" size="14"></ng-icon>
                <span><strong>Raison :</strong> {{ lesson.cancellationReason }}</span>
              </div>
            }
          }
        </div>
      }
    </section>

    <!-- History -->
    <section class="section">
      <div class="section__header">
        <h2 class="section__title">Historique</h2>
        <span class="section__count">{{ filteredHistory().length }} cours</span>
      </div>

      <!-- Filters -->
      @if (lessonService.lessonHistory().length > 0) {
        <div class="history-filters">
          <div class="history-filters__row">
            <div class="filter-group">
              <label class="filter-label">
                <ng-icon name="heroMagnifyingGlass" size="14"></ng-icon>
                {{ authService.isStudent() ? 'Coach' : 'Joueur' }}
              </label>
              <select
                class="filter-select"
                [ngModel]="historyFilterPerson()"
                (ngModelChange)="historyFilterPerson.set($event)"
              >
                <option value="">Tous</option>
                @for (person of uniquePersons(); track person) {
                  <option [value]="person">{{ person }}</option>
                }
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">
                <ng-icon name="heroCalendarDays" size="14"></ng-icon>
                Mois
              </label>
              <select
                class="filter-select"
                [ngModel]="historyFilterMonth()"
                (ngModelChange)="historyFilterMonth.set($event)"
              >
                <option value="">Tous</option>
                @for (month of uniqueMonths(); track month) {
                  <option [value]="month">{{ formatMonth(month) }}</option>
                }
              </select>
            </div>

            <div class="filter-group filter-group--checkbox">
              <label class="filter-checkbox">
                <input
                  type="checkbox"
                  [ngModel]="historyFilterHasRecording()"
                  (ngModelChange)="historyFilterHasRecording.set($event)"
                >
                <ng-icon name="heroPlayCircle" size="14"></ng-icon>
                Avec enregistrement
              </label>
            </div>

            @if (historyFilterPerson() || historyFilterMonth() || historyFilterHasRecording()) {
              <button class="filter-clear" (click)="clearHistoryFilters()">
                <ng-icon name="heroXMark" size="14"></ng-icon>
                Effacer
              </button>
            }
          </div>
        </div>
      }

      @if (lessonService.lessonHistory().length === 0) {
        <div class="empty-state">
          <div class="empty-state__icon"><ng-icon name="heroBookOpen" size="48"></ng-icon></div>
          <p class="empty-state__description">Aucun cours passe</p>
        </div>
      } @else if (filteredHistory().length === 0) {
        <div class="empty-state">
          <div class="empty-state__icon"><ng-icon name="heroFunnel" size="48"></ng-icon></div>
          <p class="empty-state__description">Aucun cours ne correspond aux filtres</p>
          <button class="btn btn--ghost btn--sm" (click)="clearHistoryFilters()">Effacer les filtres</button>
        </div>
      } @else {
        <div class="history-grid">
          @for (lesson of filteredHistory(); track lesson.id) {
            <div class="history-card" [class.history-card--has-recording]="lesson.recordingUrl">
              <!-- Delete button top right -->
              <button
                class="history-card__delete-btn"
                (click)="deleteLesson(lesson.id)"
                title="Supprimer"
              >
                <ng-icon name="heroTrash" size="14"></ng-icon>
              </button>

              <div class="history-card__header">
                <div class="history-card__date-block">
                  <span class="history-card__day">{{ lesson.scheduledAt | date:'d' }}</span>
                  <span class="history-card__month">{{ lesson.scheduledAt | date:'MMM' }}</span>
                </div>
                <div class="history-card__info">
                  <div class="history-card__person">
                    @if (authService.isStudent()) {
                      {{ lesson.teacherName }}
                    } @else {
                      <button
                        class="history-card__student-link"
                        (click)="openStudentProfile(lesson.studentId)"
                        title="Voir le profil et évaluer"
                      >
                        {{ lesson.studentName }}
                        <ng-icon name="heroUserCircle" size="16"></ng-icon>
                      </button>
                    }
                  </div>
                  <div class="history-card__time">{{ lesson.scheduledAt | date:'HH:mm' }} - {{ lesson.scheduledAt | date:'yyyy' }}</div>
                </div>
              </div>

              <div class="history-card__actions">
                @if (canRateLesson(lesson)) {
                  <button
                    class="history-card__action-btn"
                    (click)="openRatingModal(lesson)"
                    title="Noter le cours"
                  >
                    <ng-icon name="heroStar" size="14"></ng-icon> Noter le cours
                  </button>
                }
                @if (lesson.status === 'CANCELLED' && lesson.cancellationReason) {
                  <button
                    class="history-card__action-btn history-card__action-btn--info"
                    (click)="toggleReason(lesson.id)"
                    title="Voir la raison"
                  >
                    <ng-icon name="heroInformationCircle" size="14"></ng-icon>
                  </button>
                }
                @if (lesson.status === 'COMPLETED' && lesson.teacherObservations && authService.isStudent()) {
                  <button
                    class="history-card__action-btn"
                    (click)="toggleObservations(lesson.id)"
                    title="Voir les observations"
                  >
                    <ng-icon name="heroBookOpen" size="14"></ng-icon> Notes
                  </button>
                }
                @if (lesson.status === 'COMPLETED' && lesson.recordingUrl) {
                  <button
                    class="history-card__action-btn"
                    (click)="openRecording(lesson)"
                    title="Revisionner le cours"
                  >
                    <ng-icon name="heroPlayCircle" size="14"></ng-icon> Revisionner
                  </button>
                }
                @if (lesson.status === 'COMPLETED' && authService.isStudent()) {
                  <app-exercise-button [lessonId]="lesson.id"></app-exercise-button>
                }
              </div>

              @if (visibleReasonId() === lesson.id) {
                <div class="history-card__tooltip">
                  <div class="history-card__tooltip-header">Raison de l'annulation</div>
                  <div class="history-card__tooltip-content">{{ lesson.cancellationReason }}</div>
                </div>
              }
              @if (visibleObservationsId() === lesson.id) {
                <div class="history-card__tooltip history-card__tooltip--observations">
                  <div class="history-card__tooltip-header">Observations du coach</div>
                  <div class="history-card__tooltip-content">{{ lesson.teacherObservations }}</div>
                </div>
              }
            </div>
          }
        </div>
      }
    </section>

  <!-- Confirm Dialog -->
  <app-confirm-dialog #confirmDialog></app-confirm-dialog>


  <!-- Student Profile Modal (Teacher only) -->
  @if (selectedStudentId()) {
    <app-student-profile-modal
      [studentId]="selectedStudentId()!"
      (close)="closeStudentProfile()"
      (courseValidated)="onCourseValidated($event)"
    ></app-student-profile-modal>
  }

  <!-- Complete Lesson Modal -->
  @if (showCompleteModal()) {
    <div class="modal-overlay" (click)="closeCompleteModal()"></div>
    <div class="complete-modal">
      <div class="complete-modal__header">
        <h3>Terminer le cours</h3>
        <button class="complete-modal__close" (click)="closeCompleteModal()">
          <ng-icon name="heroXMark" size="20"></ng-icon>
        </button>
      </div>
      <div class="complete-modal__content">
        <label class="complete-modal__label" for="observations">
          Observations pour le joueur (optionnel)
        </label>
        <textarea
          id="observations"
          class="complete-modal__textarea"
          [ngModel]="observationsText()"
          (ngModelChange)="observationsText.set($event)"
          placeholder="Ex: Bon travail sur les ouvertures, continuer à pratiquer les finales de pions..."
          rows="4"
        ></textarea>
        <p class="complete-modal__hint">
          Ces observations seront visibles par le joueur dans son historique de cours.
        </p>
      </div>
      <div class="complete-modal__actions">
        <button class="btn btn--ghost" (click)="closeCompleteModal()">Annuler</button>
        <button class="btn btn--primary" (click)="submitCompleteLesson()">Terminer le cours</button>
      </div>
    </div>
  }

  <!-- Rating Modal -->
  @if (showRatingModal() && ratingLessonId()) {
    <app-rating-modal
      [lessonId]="ratingLessonId()!"
      [teacherName]="ratingTeacherName()"
      (close)="closeRatingModal()"
      (rated)="onRatingSubmitted()"
    ></app-rating-modal>
  }

  <!-- Video Player Modal -->
  @if (showVideoPlayer()) {
    <div class="video-player-overlay" (click)="closeVideoPlayer()">
      <div class="video-player-modal" (click)="$event.stopPropagation()">
        <div class="video-player-header">
          <h3>Enregistrement du cours</h3>
          <button class="video-player-close" (click)="closeVideoPlayer()">
            <ng-icon name="heroXMark" size="24"></ng-icon>
          </button>
        </div>
        <div class="video-player-content">
          <video
            [src]="videoPlayerUrl()"
            controls
            autoplay
            class="video-player"
          >
            Votre navigateur ne supporte pas la lecture de vidéos.
          </video>
        </div>
      </div>
    </div>
  }

  <!-- Video Call Modal (Jitsi iframe) -->
  @if (showVideoCall()) {
    <app-video-call
      [roomName]="videoCallRoomName()"
      [userName]="authService.currentUser()?.firstName + ' ' + authService.currentUser()?.lastName"
      [title]="videoCallTitle()"
      [isTeacher]="authService.isTeacher()"
      [jwtToken]="videoCallToken()"
      [isFreeTrial]="videoCallIsFreeTrial()"
      [durationMinutes]="videoCallDurationMinutes()"
      [freeTrialStartedAt]="videoCallFreeTrialStartedAt()"
      (closed)="closeVideoCall()"
    ></app-video-call>
  }
</div>
