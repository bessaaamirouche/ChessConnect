<div class="lessons-page">
    <header class="page-header">
      <div>
        <h1 class="page-header__title">{{ 'lessons.title' | translate }}</h1>
        <p class="page-header__subtitle">{{ 'lessons.subtitle' | translate }}</p>
        @if (authService.isStudent()) {
          <div class="email-reminder-toggle" [class.email-reminder-toggle--loading]="savingEmailReminders()">
            <label class="toggle">
              <input
                type="checkbox"
                [checked]="emailRemindersEnabled()"
                (change)="toggleEmailReminders()"
                [disabled]="savingEmailReminders()"
              >
              <span class="toggle__switch"></span>
            </label>
            <span class="email-reminder-toggle__label">
              <ng-icon name="heroBellAlert" size="16"></ng-icon>
              {{ 'lessons.emailReminders' | translate }}
            </span>
          </div>
        }
      </div>
      @if (authService.isStudent()) {
        <a routerLink="/teachers" class="btn btn--primary">
          <ng-icon name="heroPlus" size="16"></ng-icon> {{ 'booking.bookNow' | translate }}
        </a>
      }
    </header>

    <!-- Pending Validations Banner (Teachers only) -->
    @if (authService.isTeacher() && pendingValidations().length > 0) {
      <div class="pending-validation-banner">
        <div class="pending-validation-banner__icon">
          <ng-icon name="heroBellAlert" size="20"></ng-icon>
        </div>
        <div class="pending-validation-banner__content">
          <strong>{{ pendingValidations().length }}</strong>
          {{ 'lessons.coursesToValidate' | translate }}
        </div>
        <button class="btn btn--secondary btn--sm" (click)="openFirstPendingValidation()">
          {{ 'lessons.viewStudents' | translate }}
        </button>
      </div>
    }

    <div class="sections-container">
      <!-- Upcoming Lessons -->
      <section class="section upcoming-section">
        <div class="section-header">
          <h2 class="section__title">{{ 'lessons.upcoming.title' | translate }}</h2>
        </div>

        <div class="section-content">
          @if (lessonService.upcomingLessons().length === 0) {
            <div class="empty-state">
              <div class="empty-state__icon"><ng-icon name="heroCalendarDays" size="48"></ng-icon></div>
              <p class="empty-state__description">{{ 'lessons.upcoming.empty' | translate }}</p>
            </div>
          } @else {
            <div class="lessons-list">
          @for (lesson of lessonService.upcomingLessons(); track lesson.id) {
            <div class="lesson-card">
              <div class="lesson-card__time">
                <span class="lesson-card__time-day">{{ lesson.scheduledAt | date:'EEE' }}</span>
                <span class="lesson-card__time-date">{{ lesson.scheduledAt | date:'d' }}</span>
                <span class="lesson-card__time-hour">{{ lesson.scheduledAt | date:'HH:mm' }}</span>
              </div>

              <div class="lesson-card__content">
                <h4>
                  @if (authService.isStudent()) {
                    {{ 'lessons.details.with' | translate }} {{ lesson.teacherName }}
                  } @else if (lesson.isGroupLesson && lesson.participants && lesson.participants.length > 0) {
                    {{ 'lessons.details.with' | translate }} {{ lesson.participants[0].displayName }}
                    @if (lesson.participants.length > 1) {
                      <span class="group-others"> +{{ lesson.participants.length - 1 }}</span>
                    }
                  } @else {
                    {{ 'lessons.details.with' | translate }} {{ lesson.studentName }}
                  }
                </h4>
                @if (lesson.isGroupLesson && lesson.participants && lesson.participants.length > 1 && authService.isTeacher()) {
                  <div class="group-participants-list">
                    @for (p of lesson.participants; track p.displayName) {
                      <span class="group-participant-chip">
                        <ng-icon name="heroUser" size="12"></ng-icon>
                        {{ p.displayName }}
                        @if (p.role === 'CREATOR') {
                          <small class="creator-tag">{{ 'group_lesson.creator' | translate }}</small>
                        }
                      </span>
                    }
                  </div>
                }
                @if (authService.isTeacher()) {
                  <div class="lesson-card__student-info">
                    @if (lesson.studentLevel) {
                      <span class="student-info-badge student-info-badge--level">
                        <ng-icon name="heroTrophy" size="14"></ng-icon>
                        {{ getLevelLabel(lesson.studentLevel) }}
                      </span>
                    }
                    @if (lesson.studentAge) {
                      <span class="student-info-badge">
                        <ng-icon name="heroUser" size="14"></ng-icon>
                        {{ lesson.studentAge }} ans
                      </span>
                    }
                    @if (lesson.studentElo) {
                      <span class="student-info-badge">
                        <ng-icon name="heroChartBar" size="14"></ng-icon>
                        ELO {{ lesson.studentElo }}
                      </span>
                    }
                    <button
                      class="student-profile-btn"
                      (click)="openStudentProfile(lesson.studentId)"
                      [title]="'lessons.viewStudentProgress' | translate"
                    >
                      <ng-icon name="heroUserCircle" size="14"></ng-icon>
                      {{ 'lessons.progressAndLevels' | translate }}
                    </button>
                  </div>
                  @if (lesson.courseTitle) {
                    <div class="lesson-card__course">
                      <ng-icon name="heroBookOpen" size="14"></ng-icon>
                      {{ lesson.courseTitle }}
                    </div>
                  } @else if (lesson.status === 'PENDING') {
                    @if (getNextCourse(lesson.studentId); as nextCourse) {
                      <div class="lesson-card__course">
                        <ng-icon name="heroBookOpen" size="14"></ng-icon>
                        {{ nextCourse.title }}
                      </div>
                    }
                  }
                }
                <div class="lesson-card__meta">
                  <span class="badge" [class]="statusLabels[lesson.status].cssClass">
                    {{ getStatusLabel(lesson) }}
                  </span>
                  @if (lesson.isFromSubscription) {
                    <span class="badge badge--gold">Abo</span>
                  }
                  @if (lesson.isGroupLesson) {
                    <span class="badge badge--group">
                      <ng-icon name="heroUserGroup" size="12"></ng-icon>
                      {{ 'group_lesson.groupBadgeCount' | translate:{ current: lesson.currentParticipantCount || 1, max: lesson.maxParticipants || 3 } }}
                    </span>
                  }
                  @if (lesson.isGroupLesson && lesson.groupStatus === 'DEADLINE_PASSED' && authService.isStudent()) {
                    <span class="badge badge--warning">{{ 'group_lesson.deadlinePassed' | translate }}</span>
                  }
                </div>
              </div>

              <div class="lesson-card__actions">
                @if (lesson.status === 'PENDING' && authService.isTeacher()) {
                  <button class="btn btn--primary btn--sm" (click)="confirmLesson(lesson.id)">
                    {{ 'common.confirm' | translate }}
                  </button>
                }
                @if (lesson.status === 'CONFIRMED' && lesson.zoomLink) {
                  @if (canJoinLesson(lesson)) {
                    <button class="btn btn--primary btn--sm" (click)="openVideoCall(lesson)">
                      {{ 'lessons.upcoming.joinCall' | translate }}
                    </button>
                  } @else {
                    <span class="time-badge">{{ getTimeUntilJoin(lesson) }}</span>
                  }
                }
                @if (lesson.status === 'CONFIRMED' && authService.isTeacher() && canCompleteLesson(lesson)) {
                  <button class="btn btn--secondary btn--sm" (click)="openCompleteModal(lesson.id)">
                    {{ 'lessons.complete' | translate }}
                  </button>
                }
                @if (lesson.isGroupLesson && lesson.invitationToken && lesson.groupStatus === 'OPEN' && authService.isStudent()) {
                  <button class="btn btn--ghost btn--sm" (click)="copyInvitationLink(lesson.invitationToken!)" [title]="'group_lesson.invite' | translate">
                    <ng-icon name="heroClipboardDocument" size="16"></ng-icon>
                    {{ linkCopied() ? ('group_lesson.linkCopied' | translate) : ('group_lesson.invite' | translate) }}
                  </button>
                }
                @if (lesson.isGroupLesson && lesson.groupStatus === 'DEADLINE_PASSED' && authService.isStudent()) {
                  <button class="btn btn--primary btn--sm" (click)="openDeadlineModal(lesson.id)">
                    {{ 'group_lesson.resolveDeadline' | translate }}
                  </button>
                }
                @if (lesson.status !== 'CANCELLED' && lesson.status !== 'COMPLETED') {
                  @if (lesson.isGroupLesson && authService.isStudent()) {
                    <button class="btn btn--ghost btn--sm" (click)="leaveGroupLesson(lesson.id)">
                      {{ 'group_lesson.leaveGroup' | translate }}
                    </button>
                  } @else {
                    <button class="btn btn--ghost btn--sm" (click)="cancelLesson(lesson.id)">
                      {{ 'common.cancel' | translate }}
                    </button>
                  }
                }
                @if (lesson.status === 'CANCELLED') {
                  @if (lesson.cancellationReason) {
                    <button
                      class="btn btn--ghost btn--sm"
                      (click)="toggleReason(lesson.id)"
                      [title]="'lessons.viewReason' | translate"
                    >
                      <ng-icon name="heroInformationCircle" size="16"></ng-icon>
                    </button>
                  }
                  <button class="btn btn--ghost btn--sm" (click)="deleteLesson(lesson.id)">
                    <ng-icon name="heroTrash" size="16"></ng-icon>
                  </button>
                }
              </div>
            </div>
            @if (lesson.status === 'CANCELLED' && lesson.cancellationReason && visibleReasonId() === lesson.id) {
              <div class="reason-banner">
                <ng-icon name="heroInformationCircle" size="14"></ng-icon>
                <span><strong>{{ 'lessons.reason' | translate }}:</strong> {{ lesson.cancellationReason }}</span>
              </div>
            }
          }
            </div>
          }
        </div>
      </section>

      <!-- History -->
      <section class="section history-section">
        <div class="section-header">
          <div class="section-header__row">
            <h2 class="section__title">{{ 'lessons.history.title' | translate }}</h2>
            <span class="section__count">{{ filteredHistory().length }} {{ 'lessons.coursesCount' | translate }}</span>
          </div>

          <!-- Filters -->
          @if (lessonService.lessonHistory().length > 0) {
            <div class="history-filters">
          <div class="history-filters__row">
            <div class="filter-group">
              <label class="filter-label">
                <ng-icon name="heroMagnifyingGlass" size="14"></ng-icon>
                {{ authService.isStudent() ? ('lessons.filterCoach' | translate) : ('lessons.filterStudent' | translate) }}
              </label>
              <select
                class="filter-select"
                [ngModel]="historyFilterPerson()"
                (ngModelChange)="historyFilterPerson.set($event)"
              >
                <option value="">{{ 'common.all' | translate }}</option>
                @for (person of uniquePersons(); track person) {
                  <option [value]="person">{{ person }}</option>
                }
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">
                <ng-icon name="heroCalendarDays" size="14"></ng-icon>
                {{ 'lessons.filterMonth' | translate }}
              </label>
              <select
                class="filter-select"
                [ngModel]="historyFilterMonth()"
                (ngModelChange)="historyFilterMonth.set($event)"
              >
                <option value="">{{ 'common.all' | translate }}</option>
                @for (month of uniqueMonths(); track month) {
                  <option [value]="month">{{ formatMonth(month) }}</option>
                }
              </select>
            </div>

            <div class="filter-group filter-group--checkbox">
              <label class="filter-checkbox">
                <input
                  type="checkbox"
                  [ngModel]="historyFilterHasRecording()"
                  (ngModelChange)="historyFilterHasRecording.set($event)"
                >
                <ng-icon name="heroPlayCircle" size="14"></ng-icon>
                {{ 'lessons.withRecording' | translate }}
              </label>
            </div>

            @if (historyFilterPerson() || historyFilterMonth() || historyFilterHasRecording()) {
              <button class="filter-clear" (click)="clearHistoryFilters()">
                <ng-icon name="heroXMark" size="14"></ng-icon>
                {{ 'common.clear' | translate }}
              </button>
            }
            </div>
          </div>
          }
        </div>

        <div class="section-content">
          @if (lessonService.lessonHistory().length === 0) {
            <div class="empty-state">
              <div class="empty-state__icon"><ng-icon name="heroBookOpen" size="48"></ng-icon></div>
              <p class="empty-state__description">{{ 'lessons.history.empty' | translate }}</p>
            </div>
          } @else if (filteredHistory().length === 0) {
            <div class="empty-state">
              <div class="empty-state__icon"><ng-icon name="heroFunnel" size="48"></ng-icon></div>
              <p class="empty-state__description">{{ 'lessons.noMatchingFilters' | translate }}</p>
              <button class="btn btn--ghost btn--sm" (click)="clearHistoryFilters()">{{ 'lessons.clearFilters' | translate }}</button>
            </div>
          } @else {
            <div class="history-grid">
          @for (lesson of historyPagination.paginatedItems(); track lesson.id) {
            <div class="history-card" [class.history-card--has-recording]="lesson.recordingUrl">
              <div class="history-card__header">
                <div class="history-card__date-block">
                  <span class="history-card__day">{{ lesson.scheduledAt | date:'d' }}</span>
                  <span class="history-card__month">{{ lesson.scheduledAt | date:'MMM' }}</span>
                </div>
                <div class="history-card__info">
                  <div class="history-card__person">
                    @if (authService.isStudent()) {
                      {{ lesson.teacherName }}
                    } @else if (lesson.isGroupLesson && lesson.participants && lesson.participants.length > 0) {
                      {{ lesson.participants[0].displayName }}
                      @if (lesson.participants.length > 1) {
                        <span class="group-others"> +{{ lesson.participants.length - 1 }}</span>
                      }
                    } @else {
                      {{ lesson.studentName }}
                    }
                  </div>
                  <div class="history-card__time">{{ lesson.scheduledAt | date:'HH:mm' }} - {{ lesson.scheduledAt | date:'yyyy' }}</div>
                </div>
              </div>

              <div class="history-card__actions">
                <span class="badge badge--sm" [class]="statusLabels[lesson.status].cssClass">
                  {{ getStatusLabel(lesson) }}
                </span>
                @if (lesson.isGroupLesson) {
                  <span class="badge badge--sm badge--group">
                    <ng-icon name="heroUserGroup" size="10"></ng-icon>
                    {{ 'group_lesson.groupBadge' | translate }}
                  </span>
                }
                <div class="history-card__dropdown">
                  <button
                    class="history-card__dropdown-trigger"
                    (click)="toggleDropdown(lesson.id, $event)"
                    title="Actions"
                  >
                    <ng-icon name="heroEllipsisVertical" size="18"></ng-icon>
                  </button>
                  @if (openDropdownId() === lesson.id) {
                    <div class="history-card__dropdown-backdrop" (click)="closeDropdown()"></div>
                    <div class="history-card__dropdown-menu">
                      @if (authService.isTeacher()) {
                        <button class="history-card__dropdown-item" (click)="openStudentProfile(lesson.studentId)">
                          <ng-icon name="heroUserCircle" size="16"></ng-icon>
                          {{ 'lessons.validateProgress' | translate }}
                        </button>
                      }
                      @if (lesson.status === 'CANCELLED' && lesson.cancellationReason) {
                        <button class="history-card__dropdown-item" (click)="toggleReason(lesson.id)">
                          <ng-icon name="heroInformationCircle" size="16"></ng-icon>
                          {{ 'lessons.cancellationReason' | translate }}
                        </button>
                      }
                      @if (lesson.status === 'COMPLETED' && lesson.teacherObservations && authService.isStudent()) {
                        <button class="history-card__dropdown-item" (click)="toggleObservations(lesson.id)">
                          <ng-icon name="heroBookOpen" size="16"></ng-icon>
                          {{ 'lessons.coachNotes' | translate }}
                        </button>
                      }
                      @if (lesson.status === 'COMPLETED' && authService.isTeacher()) {
                        <button class="history-card__dropdown-item" (click)="openCommentModal(lesson)">
                          <ng-icon name="heroChatBubbleLeftRight" size="16"></ng-icon>
                          {{ lesson.teacherComment ? ('lessons.editComment' | translate) : ('lessons.addComment' | translate) }}
                        </button>
                      }
                      @if (lesson.status === 'COMPLETED' && lesson.teacherComment && authService.isStudent()) {
                        <button class="history-card__dropdown-item" (click)="openViewCommentModal(lesson)">
                          <ng-icon name="heroChatBubbleLeftRight" size="16"></ng-icon>
                          {{ 'lessons.coachMessage' | translate }}
                        </button>
                      }
                      @if (lesson.status === 'COMPLETED' && lesson.recordingUrl) {
                        <button class="history-card__dropdown-item" (click)="openRecording(lesson)">
                          <ng-icon name="heroPlayCircle" size="16"></ng-icon>
                          {{ 'lessons.history.viewRecording' | translate }}
                        </button>
                      }
                      @if (lesson.status === 'COMPLETED' && authService.isStudent()) {
                        @if (paymentService.hasActiveSubscription()) {
                          <a [routerLink]="['/exercise', lesson.id]" class="history-card__dropdown-item">
                            <ng-icon name="heroCpuChip" size="16"></ng-icon>
                            {{ 'lessons.history.practice' | translate }}
                          </a>
                        } @else {
                          <a routerLink="/subscription" [queryParams]="{ required: 'exercise' }" class="history-card__dropdown-item history-card__dropdown-item--locked">
                            <ng-icon name="heroLockClosed" size="16"></ng-icon>
                            {{ 'lessons.history.practice' | translate }} ({{ 'common.premium' | translate }})
                          </a>
                        }
                      }
                      @if (canRateLesson(lesson)) {
                        <button class="history-card__dropdown-item history-card__dropdown-item--highlight" (click)="openRatingModal(lesson)">
                          <ng-icon name="heroStar" size="16"></ng-icon>
                          {{ 'lessons.history.rateLesson' | translate }}
                        </button>
                      }
                      <div class="history-card__dropdown-divider"></div>
                      <button class="history-card__dropdown-item history-card__dropdown-item--danger" (click)="deleteLesson(lesson.id)">
                        <ng-icon name="heroTrash" size="16"></ng-icon>
                        {{ 'common.delete' | translate }}
                      </button>
                    </div>
                  }
                </div>
              </div>

              @if (visibleReasonId() === lesson.id) {
                <div class="history-card__tooltip">
                  <div class="history-card__tooltip-header">{{ 'lessons.cancellationReason' | translate }}</div>
                  <div class="history-card__tooltip-content">{{ lesson.cancellationReason }}</div>
                </div>
              }
              @if (visibleObservationsId() === lesson.id) {
                <div class="history-card__tooltip history-card__tooltip--observations">
                  <div class="history-card__tooltip-header">{{ 'lessons.coachObservations' | translate }}</div>
                  <div class="history-card__tooltip-content">{{ lesson.teacherObservations }}</div>
                </div>
              }
            </div>
          }
            </div>

            <app-pagination
              [currentPage]="historyPagination.currentPage()"
              [totalPages]="historyPagination.totalPages()"
              [totalItems]="historyPagination.totalItems()"
              [startItem]="historyPagination.startItem()"
              [endItem]="historyPagination.endItem()"
              [visiblePages]="historyPagination.visiblePages()"
              (pageChange)="historyPagination.goToPage($event)"
            />
          }
        </div>
      </section>
    </div>

  <!-- Confirm Dialog -->
  <app-confirm-dialog #confirmDialog></app-confirm-dialog>


  <!-- Student Profile Modal (Teacher only) -->
  @if (selectedStudentId()) {
    <app-student-profile-modal
      [studentId]="selectedStudentId()!"
      (close)="closeStudentProfile()"
      (courseValidated)="onCourseValidated($event)"
      (closedWithoutValidation)="onStudentProfileClosedWithoutValidation($event)"
    ></app-student-profile-modal>
  }

  <!-- Student Evaluation Modal (After lesson completion) -->
  @if (showEvaluationModal() && evaluationStudentId() && evaluationLessonId()) {
    <app-student-evaluation-modal
      [studentId]="evaluationStudentId()!"
      [lessonId]="evaluationLessonId()!"
      (close)="closeEvaluationModal()"
      (levelSet)="onLevelSet($event)"
      (courseValidated)="onEvaluationCourseValidated($event)"
    ></app-student-evaluation-modal>
  }

  <!-- Complete Lesson Modal -->
  @if (showCompleteModal()) {
    <div class="modal-overlay" (click)="closeCompleteModal()"></div>
    <div class="complete-modal">
      <div class="complete-modal__header">
        <h3>{{ 'lessons.completeLesson' | translate }}</h3>
        <button class="complete-modal__close" (click)="closeCompleteModal()">
          <ng-icon name="heroXMark" size="20"></ng-icon>
        </button>
      </div>
      <div class="complete-modal__content">
        <label class="complete-modal__label" for="observations">
          {{ 'lessons.observationsLabel' | translate }}
        </label>
        <textarea
          id="observations"
          class="complete-modal__textarea"
          [ngModel]="observationsText()"
          (ngModelChange)="observationsText.set($event)"
          [placeholder]="'lessons.observationsPlaceholder' | translate"
          rows="4"
        ></textarea>
        <p class="complete-modal__hint">
          {{ 'lessons.observationsHint' | translate }}
        </p>
      </div>
      <div class="complete-modal__actions">
        <button class="btn btn--ghost" (click)="closeCompleteModal()">{{ 'common.cancel' | translate }}</button>
        <button class="btn btn--primary" (click)="submitCompleteLesson()">{{ 'lessons.completeLesson' | translate }}</button>
      </div>
    </div>
  }

  <!-- Rating Modal -->
  @if (showRatingModal() && ratingLessonId()) {
    <app-rating-modal
      [lessonId]="ratingLessonId()!"
      [teacherName]="ratingTeacherName()"
      (close)="closeRatingModal()"
      (rated)="onRatingSubmitted()"
    ></app-rating-modal>
  }

  <!-- Video Player Modal -->
  @if (showVideoPlayer()) {
    <app-video-player
      [url]="videoPlayerUrl()"
      [videoId]="videoPlayerLessonId()"
      [title]="videoPlayerTitle()"
      (close)="closeVideoPlayer()"
    ></app-video-player>
  }

  <!-- Video Call Modal (Jitsi iframe) -->
  @if (showVideoCall()) {
    <app-video-call
      [roomName]="videoCallRoomName()"
      [userName]="authService.currentUser()?.firstName + ' ' + authService.currentUser()?.lastName"
      [title]="videoCallTitle()"
      [isTeacher]="authService.isTeacher()"
      [recordingEnabled]="videoCallRecordingEnabled()"
      [jwtToken]="videoCallToken()"
      [durationMinutes]="videoCallDurationMinutes()"
      (closed)="closeVideoCall()"
    ></app-video-call>
  }

  <!-- Teacher Comment Modal -->
  @if (showCommentModal()) {
    <div class="modal-overlay" (click)="closeCommentModal()"></div>
    <div class="comment-modal">
      <div class="comment-modal__header">
        <h3>{{ commentLessonId() && getCommentForLesson(commentLessonId()!) ? ('lessons.editComment' | translate) : ('lessons.addComment' | translate) }}</h3>
        <button class="comment-modal__close" (click)="closeCommentModal()">
          <ng-icon name="heroXMark" size="20"></ng-icon>
        </button>
      </div>
      <div class="comment-modal__content">
        <p class="comment-modal__info">
          <ng-icon name="heroInformationCircle" size="16"></ng-icon>
          {{ 'lessons.commentVisibleHint' | translate }}
        </p>
        <label class="comment-modal__label" for="teacherComment">
          {{ 'lessons.yourMessageFor' | translate }} {{ commentStudentName() }}
        </label>
        <textarea
          id="teacherComment"
          class="comment-modal__textarea"
          [ngModel]="commentText()"
          (ngModelChange)="commentText.set($event)"
          [placeholder]="'lessons.commentPlaceholder' | translate"
          rows="5"
        ></textarea>
      </div>
      <div class="comment-modal__actions">
        <button class="btn btn--ghost" (click)="closeCommentModal()">{{ 'common.cancel' | translate }}</button>
        <button
          class="btn btn--primary"
          (click)="submitComment()"
          [disabled]="savingComment()"
        >
          @if (savingComment()) {
            <span class="spinner spinner--sm"></span>
          } @else {
            {{ 'common.save' | translate }}
          }
        </button>
      </div>
    </div>
  }

  <!-- Group Deadline Resolution Modal -->
  @if (showDeadlineModal()) {
    <div class="modal-overlay" (click)="closeDeadlineModal()"></div>
    <div class="complete-modal">
      <div class="complete-modal__header">
        <h3>{{ 'group_lesson.resolveDeadline' | translate }}</h3>
        <button class="complete-modal__close" (click)="closeDeadlineModal()">
          <ng-icon name="heroXMark" size="20"></ng-icon>
        </button>
      </div>
      <div class="complete-modal__content">
        <div class="deadline-options">
          <button
            class="deadline-option"
            [disabled]="resolvingDeadline()"
            (click)="resolveDeadline('PAY_FULL')"
          >
            <strong>{{ 'group_lesson.payFull' | translate }}</strong>
            <span>{{ 'group_lesson.payFullDesc' | translate:{ amount: '' } }}</span>
          </button>
          <button
            class="deadline-option deadline-option--danger"
            [disabled]="resolvingDeadline()"
            (click)="resolveDeadline('CANCEL')"
          >
            <strong>{{ 'group_lesson.cancelGroup' | translate }}</strong>
            <span>{{ 'group_lesson.cancelGroupDesc' | translate }}</span>
          </button>
        </div>
        @if (resolvingDeadline()) {
          <div class="deadline-loading">
            <span class="spinner spinner--sm"></span>
            {{ 'group_lesson.resolving' | translate }}
          </div>
        }
      </div>
    </div>
  }

  <!-- View Comment Modal (Student reading coach message) -->
  @if (showViewCommentModal()) {
    <div class="modal-overlay" (click)="closeViewCommentModal()"></div>
    <div class="view-comment-modal">
      <div class="view-comment-modal__header">
        <h3>{{ 'lessons.messageFrom' | translate }} {{ viewCommentTeacherName() }}</h3>
        <button class="view-comment-modal__close" (click)="closeViewCommentModal()">
          <ng-icon name="heroXMark" size="20"></ng-icon>
        </button>
      </div>
      <div class="view-comment-modal__content">
        <p class="view-comment-modal__text">{{ viewCommentText() }}</p>
        @if (viewCommentDate()) {
          <p class="view-comment-modal__date">{{ viewCommentDate() | date:'d MMMM yyyy' }}</p>
        }
      </div>
      <div class="view-comment-modal__actions">
        <button class="btn btn--primary" (click)="closeViewCommentModal()">{{ 'common.close' | translate }}</button>
      </div>
    </div>
  }
</div>
