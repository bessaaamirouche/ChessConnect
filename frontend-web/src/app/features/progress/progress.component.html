<div class="progress-page">
  <header class="page-header">
    <div>
      <h1 class="page-header__title">{{ 'progress.title' | translate }}</h1>
      @if (!loading() && !error()) {
        <p class="page-header__subtitle">{{ totalValidatedCourses() }} {{ 'progress.coursesCompleted' | translate }} / {{ totalCourses() }}</p>
      }
    </div>
  </header>

  @if (loading()) {
    <div class="loading-state">
      <span class="spinner spinner--lg"></span>
      <p>{{ 'progress.loading' | translate }}</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <div class="error-state__icon"><ng-icon name="heroExclamationTriangle" size="48"></ng-icon></div>
      <h3>{{ 'progress.error' | translate }}</h3>
      <p>{{ error() }}</p>
      <button class="btn btn--primary" (click)="learningPathService.loadLearningPath().subscribe()">
        {{ 'common.retry' | translate }}
      </button>
    </div>
  } @else {
    <!-- Levels Accordion -->
    <section class="section">
      <div class="levels-timeline">
        @for (level of programmeLevels(); track level.code; let i = $index; let last = $last) {
          <div
            class="level-card"
            [class.completed]="isLevelCompleted(level)"
            [class.current]="isLevelInProgress(level)"
            [class.locked]="!level.isUnlocked"
            [class.expanded]="isExpanded(level.code)"
          >
            <!-- Card Header (clickable) -->
            <button
              class="level-card__header"
              (click)="toggleLevel(level.code)"
            >
              <div
                class="level-card__icon"
                [style.border-color]="level.isUnlocked ? level.color : '#4a4a4a'"
                [style.background-color]="isLevelCompleted(level) ? level.color : 'transparent'"
              >
                @if (isLevelCompleted(level)) {
                  <ng-icon name="heroCheckCircle" class="level-card__check"></ng-icon>
                } @else {
                  <span [style.color]="level.isUnlocked ? level.color : '#6b6b6b'">
                    {{ getLevelIcon(level.code) }}
                  </span>
                }
              </div>

              <div class="level-card__content">
                <h4 class="level-card__title" [style.color]="!level.isUnlocked ? '#6b6b6b' : '#fff'">
                  {{ level.name }}
                </h4>
                @if (isLevelInProgress(level)) {
                  <span class="level-card__badge">{{ 'progress.inProgress' | translate }}</span>
                }
              </div>

              <div class="level-card__progress">
                <span class="level-card__progress-text">
                  {{ level.completedCourses }}/{{ level.totalCourses }} {{ 'progress.courses' | translate }}
                </span>
              </div>

              <div class="level-card__chevron">
                @if (!level.isUnlocked) {
                  <ng-icon name="heroLockClosed" class="level-card__lock-indicator"></ng-icon>
                }
                <ng-icon [name]="isExpanded(level.code) ? 'heroChevronUp' : 'heroChevronDown'"></ng-icon>
              </div>
            </button>

            <!-- Accordion Content (courses list) -->
            @if (isExpanded(level.code)) {
              <div class="level-card__courses">
                @for (course of level.courses; track course.id; let courseIndex = $index) {
                  <div class="course-item" [class.course-item--completed]="course.status === 'COMPLETED'" [class.course-item--locked]="course.status === 'LOCKED'">
                    <span class="course-item__order">{{ courseIndex + 1 }}.</span>
                    <span class="course-item__title">{{ course.title }}</span>
                    <span class="course-item__status">
                      @switch (course.status) {
                        @case ('COMPLETED') {
                          <ng-icon name="heroCheckCircle" class="course-item__icon course-item__icon--completed"></ng-icon>
                        }
                        @case ('IN_PROGRESS') {
                          <ng-icon name="heroClock" class="course-item__icon course-item__icon--in-progress"></ng-icon>
                        }
                        @case ('PENDING_VALIDATION') {
                          <ng-icon name="heroCheckBadge" class="course-item__icon course-item__icon--pending"></ng-icon>
                        }
                        @case ('LOCKED') {
                          <ng-icon name="heroLockClosed" class="course-item__icon course-item__icon--locked"></ng-icon>
                        }
                      }
                    </span>
                  </div>
                } @empty {
                  <p class="level-card__empty">{{ 'progress.noCourses' | translate }}</p>
                }
              </div>
            }
          </div>

          @if (!last) {
            <div
              class="level-connector"
              [class.completed]="programmeLevels()[i + 1]?.isUnlocked"
            ></div>
          }
        }
      </div>
    </section>

    <!-- Call to Action -->
    <section class="section">
      <div class="cta-card">
        <div class="cta-card__content">
          <h3>{{ 'progress.cta.title' | translate }}</h3>
          <p>{{ 'progress.cta.description' | translate }}</p>
        </div>
        <a routerLink="/teachers" class="btn btn--primary btn--lg">
          {{ 'progress.cta.findCoach' | translate }}
        </a>
      </div>
    </section>

    <!-- Retake Quiz Option -->
    <section class="section">
      <div class="quiz-cta-card">
        <div class="quiz-cta-card__icon">â™Ÿ</div>
        <div class="quiz-cta-card__content">
          <h4>{{ 'progress.quiz.title' | translate }}</h4>
          <p>{{ 'progress.quiz.description' | translate }}</p>
        </div>
        <a routerLink="/quiz" class="btn btn--secondary">
          {{ 'progress.quiz.takeQuiz' | translate }}
        </a>
      </div>
    </section>
  }
</div>
