<div class="quiz-page">
    <div class="quiz-wrapper">
      <!-- Intro Step -->
      @if (step() === 'intro') {
        <div class="quiz-intro">
          <div class="quiz-intro__icon">♟</div>
          <h1 class="quiz-intro__title">Testez vos connaissances</h1>
          <p class="quiz-intro__description">
            Ce quiz est indicatif et vous permet de tester vos connaissances aux échecs.
            Votre niveau officiel sera déterminé par votre coach lors de votre premier cours.
          </p>

          <div class="quiz-intro__info">
            <div class="quiz-intro__info-item">
              <span class="quiz-intro__info-value">30</span>
              <span class="quiz-intro__info-label">Questions</span>
            </div>
            <div class="quiz-intro__info-item">
              <span class="quiz-intro__info-value">6</span>
              <span class="quiz-intro__info-label">Niveaux</span>
            </div>
            <div class="quiz-intro__info-item">
              <span class="quiz-intro__info-value">70%</span>
              <span class="quiz-intro__info-label">Pour passer</span>
            </div>
          </div>

          <div class="quiz-intro__levels">
            <h3>Niveaux évalués</h3>
            <div class="quiz-intro__levels-list">
              @for (level of levels; track level) {
                <div class="quiz-intro__level">
                  <span class="quiz-intro__level-icon">{{ getLevelIcon(level) }}</span>
                  <span class="quiz-intro__level-name">{{ CHESS_LEVELS[level].label }}</span>
                  <span class="quiz-intro__level-desc">{{ CHESS_LEVELS[level].description }}</span>
                </div>
              }
            </div>
          </div>

          <button class="btn btn--primary btn--lg quiz-intro__start" (click)="startQuiz()" [disabled]="quizService.loading()">
            @if (quizService.loading()) {
              <span class="spinner spinner--sm"></span>
              Chargement...
            } @else {
              <ng-icon name="heroPlayCircle"></ng-icon>
              Commencer le quiz
            }
          </button>

          <a routerLink="/progress" class="quiz-intro__skip">
            Passer et commencer au niveau Pion
          </a>
        </div>
      }

      <!-- Questions Step -->
      @if (step() === 'questions') {
        <div class="quiz-questions">
          <!-- Progress Bar -->
          <div class="quiz-progress">
            <div class="quiz-progress__info">
              <span class="quiz-progress__current">
                Question {{ quizService.currentIndex() + 1 }} / {{ quizService.totalQuestions() }}
              </span>
              <span class="quiz-progress__level">
                Niveau {{ quizService.currentQuestion()!.level }}
              </span>
            </div>
            <div class="quiz-progress__bar">
              <div class="quiz-progress__fill" [style.width.%]="quizService.progressPercentage()"></div>
            </div>
          </div>

          <!-- Question Card -->
          @if (quizService.currentQuestion(); as question) {
            <div class="quiz-card">
              <div class="quiz-card__header">
                <span class="quiz-card__level-badge">
                  {{ getLevelIcon(question.level) }} {{ CHESS_LEVELS[question.level].label }}
                </span>
              </div>

              <h2 class="quiz-card__question">{{ question.question }}</h2>

              <div class="quiz-card__options">
                <button
                  class="quiz-option"
                  [class.quiz-option--selected]="isAnswerSelected('A')"
                  (click)="selectAnswer('A')"
                >
                  <span class="quiz-option__letter">A</span>
                  <span class="quiz-option__text">{{ question.optionA }}</span>
                </button>

                <button
                  class="quiz-option"
                  [class.quiz-option--selected]="isAnswerSelected('B')"
                  (click)="selectAnswer('B')"
                >
                  <span class="quiz-option__letter">B</span>
                  <span class="quiz-option__text">{{ question.optionB }}</span>
                </button>

                <button
                  class="quiz-option"
                  [class.quiz-option--selected]="isAnswerSelected('C')"
                  (click)="selectAnswer('C')"
                >
                  <span class="quiz-option__letter">C</span>
                  <span class="quiz-option__text">{{ question.optionC }}</span>
                </button>

                @if (question.optionD) {
                  <button
                    class="quiz-option"
                    [class.quiz-option--selected]="isAnswerSelected('D')"
                    (click)="selectAnswer('D')"
                  >
                    <span class="quiz-option__letter">D</span>
                    <span class="quiz-option__text">{{ question.optionD }}</span>
                  </button>
                }
              </div>
            </div>
          }

          <!-- Navigation -->
          <div class="quiz-nav">
            <button
              class="btn btn--secondary"
              (click)="goPrevious()"
              [disabled]="quizService.isFirstQuestion()"
            >
              <ng-icon name="heroArrowLeft"></ng-icon>
              Précédent
            </button>

            <span class="quiz-nav__answered">
              {{ quizService.answeredCount() }} / {{ quizService.totalQuestions() }} répondues
            </span>

            <div class="quiz-nav__right">
              @if (!quizService.isLastQuestion()) {
                <button
                  class="btn btn--ghost"
                  (click)="skipQuestion()"
                  [disabled]="quizService.submitting()"
                >
                  Passer
                </button>
              }

              <button
                class="btn btn--primary"
                (click)="goNext()"
                [disabled]="!quizService.currentAnswer() || quizService.submitting()"
              >
                @if (quizService.submitting()) {
                  <span class="spinner spinner--sm"></span>
                  Envoi...
                } @else if (quizService.isLastQuestion()) {
                  Terminer
                  <ng-icon name="heroCheckCircle"></ng-icon>
                } @else {
                  Suivant
                  <ng-icon name="heroArrowRight"></ng-icon>
                }
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Result Step -->
      @if (step() === 'result') {
        @if (quizService.result(); as result) {
          <div class="quiz-result">
            <div class="quiz-result__header">
              <div class="quiz-result__icon">{{ getLevelIcon(result.determinedLevel) }}</div>
              <h1 class="quiz-result__title">Niveau suggéré : {{ result.levelDisplayName }}</h1>
              <p class="quiz-result__subtitle">{{ result.levelDescription }}</p>
            </div>

            <p class="quiz-result__message">{{ result.message }}</p>

            <div class="quiz-result__notice">
              <strong>Note :</strong> Ce résultat est indicatif. Votre coach évaluera officiellement votre niveau lors de votre premier cours avec des exercices pratiques.
            </div>

            <!-- Scores by Level -->
            <div class="quiz-result__scores">
              <h3>Résultats par niveau</h3>
              <div class="quiz-result__scores-list">
                @for (level of levels; track level) {
                  <div class="quiz-result__score" [class.quiz-result__score--passed]="isLevelPassed(level)" [class.quiz-result__score--failed]="isLevelEvaluated(level) && !isLevelPassed(level)" [class.quiz-result__score--not-evaluated]="!isLevelEvaluated(level)">
                    <span class="quiz-result__score-icon">{{ getLevelIcon(level) }}</span>
                    <span class="quiz-result__score-name">{{ CHESS_LEVELS[level].label }}</span>
                    <span class="quiz-result__score-value">
                      @if (isLevelEvaluated(level)) {
                        {{ result.scoresByLevel[level] }}/{{ result.totalByLevel[level] }}
                        <span class="quiz-result__score-percent">({{ getScorePercentage(level) }}%)</span>
                      } @else {
                        -
                      }
                    </span>
                    <span class="quiz-result__score-status">
                      @if (isLevelEvaluated(level)) {
                        @if (isLevelPassed(level)) {
                          <ng-icon name="heroCheckCircle" class="text-success"></ng-icon>
                        } @else {
                          <ng-icon name="heroXCircle" class="text-error"></ng-icon>
                        }
                      } @else {
                        <span class="text-muted">Non évalué</span>
                      }
                    </span>
                  </div>
                }
              </div>
            </div>

            <!-- Actions -->
            <div class="quiz-result__actions">
              <button class="btn btn--primary btn--lg" (click)="goToProgress()">
                Voir mon parcours
                <ng-icon name="heroArrowRight"></ng-icon>
              </button>
              <button class="btn btn--secondary" (click)="retakeQuiz()">
                Refaire le quiz
              </button>
            </div>
          </div>
        }
      }

      <!-- Error -->
      @if (quizService.error()) {
        <div class="quiz-error">
          <p>{{ quizService.error() }}</p>
          <button class="btn btn--secondary" (click)="quizService.clearError()">Fermer</button>
        </div>
      }
    </div>
</div>
