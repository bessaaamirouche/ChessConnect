<div class="subscription-page">
    <header class="page-header">
      <div>
        <h1 class="page-header__title">Abonnement Premium</h1>
        <p class="page-header__subtitle">Débloquez toutes les fonctionnalités exclusives pour 4,99€/mois</p>
      </div>
    </header>

    <!-- Active Free Trial Section -->
    @if (paymentService.hasActiveTrial() && !paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Essai Premium Gratuit</h2>
        </div>

        <div class="active-subscription-card active-subscription-card--trial">
          <div class="active-subscription-card__badge active-subscription-card__badge--trial">
            <ng-icon name="heroClock" size="16"></ng-icon>
            Essai gratuit
          </div>
          <div class="active-subscription-card__content">
            <div class="active-subscription-card__plan">
              <span class="active-subscription-card__plan-icon"><ng-icon name="heroSparkles" size="32"></ng-icon></span>
              <div>
                <h3>Premium Trial</h3>
                <p class="active-subscription-card__price">
                  Gratuit pendant 14 jours
                </p>
              </div>
            </div>

            <div class="active-subscription-card__trial-info">
              <ng-icon name="heroInformationCircle" size="18"></ng-icon>
              <span>
                Il vous reste <strong>{{ paymentService.freeTrialStatus()?.daysRemaining }} jour(s)</strong>.
                Fin de l'essai le <strong>{{ paymentService.freeTrialStatus()?.trialEndDate | date:'dd/MM/yyyy' }}</strong>.
              </span>
            </div>

            <div class="active-subscription-card__row">
              <div class="active-subscription-card__features">
                <h4>Vos avantages Premium</h4>
                <ul class="premium-features-list">
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Revisionnage des cours</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Reprise automatique</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Notifications prioritaires</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Badge Premium</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Entraînement myChessBot</li>
                </ul>
              </div>
            </div>

            <div class="active-subscription-card__cta">
              <p class="text-muted">Aimez votre essai ? Passez à Premium pour garder l'accès.</p>
              @for (plan of paymentService.plans(); track plan.code) {
                <button
                  class="btn btn--primary btn--lg"
                  (click)="subscribeToPlan(plan.code)"
                  [disabled]="processingPlan() !== null"
                >
                  @if (processingPlan() === plan.code) {
                    <span class="spinner spinner--sm"></span>
                    Redirection...
                  } @else {
                    Passer à Premium - {{ formatPrice(plan.priceCents) }}/mois
                  }
                </button>
              }
            </div>
          </div>
        </div>
      </section>
    }

    <!-- Trial Success Message -->
    @if (trialSuccess()) {
      <div class="trial-success-banner">
        <ng-icon name="heroCheck" size="24"></ng-icon>
        <div>
          <strong>Essai gratuit activé !</strong>
          <p>Profitez de toutes les fonctionnalités Premium pendant 14 jours.</p>
        </div>
        <a routerLink="/teachers" class="btn btn--primary">Réserver un cours</a>
      </div>
    }

    <!-- Active Subscription Section -->
    @if (paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">
            @if (paymentService.activeSubscription()!.cancelledAt) {
              Abonnement annulé
            } @else {
              Vous êtes Premium !
            }
          </h2>
        </div>

        <div class="active-subscription-card" [class.active-subscription-card--cancelled]="paymentService.activeSubscription()!.cancelledAt">
          @if (paymentService.activeSubscription()!.cancelledAt) {
            <div class="active-subscription-card__badge active-subscription-card__badge--cancelled">Annulé</div>
          } @else {
            <div class="active-subscription-card__badge active-subscription-card__badge--premium">
              <ng-icon name="heroSparkles" size="16"></ng-icon>
              Premium
            </div>
          }
          <div class="active-subscription-card__content">
            <div class="active-subscription-card__plan">
              <span class="active-subscription-card__plan-icon"><ng-icon name="heroTrophy" size="32"></ng-icon></span>
              <div>
                <h3>{{ paymentService.activeSubscription()!.planName || 'Premium' }}</h3>
                <p class="active-subscription-card__price">
                  {{ formatPrice(paymentService.activeSubscription()!.priceCents) }}/mois
                </p>
              </div>
            </div>

            @if (paymentService.activeSubscription()!.cancelledAt && paymentService.activeSubscription()!.endDate) {
              <div class="active-subscription-card__cancelled-info">
                <ng-icon name="heroInformationCircle" size="18"></ng-icon>
                <span>Votre abonnement reste actif jusqu'au <strong>{{ paymentService.activeSubscription()!.endDate | date:'dd/MM/yyyy' }}</strong>.</span>
              </div>
            }

            <div class="active-subscription-card__row">
              <div class="active-subscription-card__features">
                <h4>Vos avantages Premium</h4>
                <ul class="premium-features-list">
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Revisionnage des cours</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Reprise automatique</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Notifications prioritaires</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Badge Premium</li>
                  <li><ng-icon name="heroCheck" size="18"></ng-icon> Entraînement myChessBot</li>
                </ul>
              </div>

              <div class="active-subscription-card__stats">
                <div class="stat-item">
                  <span class="stat-item__value">{{ paymentService.activeSubscription()!.startDate | date:'dd/MM/yyyy' }}</span>
                  <span class="stat-item__label">Membre depuis</span>
                </div>
                @if (paymentService.activeSubscription()!.cancelledAt && paymentService.activeSubscription()!.endDate) {
                  <div class="stat-item">
                    <span class="stat-item__value">{{ paymentService.activeSubscription()!.endDate | date:'dd/MM/yyyy' }}</span>
                    <span class="stat-item__label">Fin le</span>
                  </div>
                }
              </div>
            </div>

            <div class="active-subscription-card__actions">
              <a routerLink="/teachers" class="btn btn--primary">Réserver un cours</a>
              @if (!paymentService.activeSubscription()!.cancelledAt) {
                <button class="btn btn--ghost btn--danger" (click)="confirmCancel()">
                  Annuler l'abonnement
                </button>
              }
            </div>
          </div>
        </div>
      </section>
    }

    <!-- Cancel Confirmation Modal -->
    @if (showCancelConfirm()) {
      <div class="modal-overlay" (click)="dismissCancelConfirm()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal__header">
            <h3>Confirmer l'annulation</h3>
          </div>
          <div class="modal__body">
            <p>Êtes-vous sûr de vouloir annuler votre abonnement Premium ?</p>
            <p class="text-muted">Vous perdrez l'accès aux fonctionnalités exclusives à la fin de la période en cours.</p>
          </div>
          <div class="modal__footer">
            <button class="btn btn--ghost" (click)="dismissCancelConfirm()">Annuler</button>
            <button
              class="btn btn--danger"
              (click)="cancelSubscription()"
              [disabled]="cancelling()"
            >
              @if (cancelling()) {
                <span class="spinner spinner--sm"></span>
                Annulation...
              } @else {
                Confirmer l'annulation
              }
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Plans Section -->
    @if (!paymentService.activeSubscription() && !paymentService.hasActiveTrial()) {
      <!-- Free Trial Banner (without card) -->
      @if (paymentService.canStartFreeTrial()) {
        <div class="trial-banner trial-banner--free">
          <div class="trial-banner__icon">
            <ng-icon name="heroSparkles" size="24"></ng-icon>
          </div>
          <div class="trial-banner__content">
            <strong>Essayez Premium gratuitement pendant 14 jours !</strong>
            <p>Aucune carte bancaire requise. Découvrez toutes les fonctionnalités exclusives sans engagement.</p>
          </div>
          <button
            class="btn btn--gold trial-banner__btn"
            (click)="startFreeTrial()"
            [disabled]="startingTrial()"
          >
            @if (startingTrial()) {
              <span class="spinner spinner--sm"></span>
              Activation...
            } @else {
              Démarrer l'essai gratuit
            }
          </button>
        </div>
      }

      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Passez Premium</h2>
        </div>

        @if (paymentService.loading()) {
          <div class="loading-state">
            <span class="spinner spinner--lg"></span>
          </div>
        } @else {
          <div class="premium-plan-container">
            @for (plan of paymentService.plans(); track plan.code) {
              <div class="plan-card plan-card--premium">
                <div class="plan-card__badge plan-card__badge--gold">
                  <ng-icon name="heroSparkles" size="14"></ng-icon>
                  Recommandé
                </div>

                <div class="plan-card__header">
                  <h3 class="plan-card__name">{{ plan.name }}</h3>
                  <div class="plan-card__price">
                    <span class="plan-card__price-amount">{{ formatPrice(plan.priceCents) }}</span>
                    <span class="plan-card__price-period">/mois</span>
                  </div>
                  <p class="plan-card__tagline">Accès à toutes les fonctionnalités exclusives</p>
                </div>

                <ul class="plan-card__features">
                  @for (feature of plan.features; track feature) {
                    <li>
                      <ng-icon name="heroCheck" class="plan-card__feature-check"></ng-icon>
                      {{ feature }}
                    </li>
                  }
                </ul>

                <button
                  class="btn btn--primary btn--lg plan-card__btn"
                  (click)="subscribeToPlan(plan.code)"
                  [disabled]="processingPlan() !== null"
                >
                  @if (processingPlan() === plan.code) {
                    <span class="spinner spinner--sm"></span>
                    Redirection...
                  } @else {
                    <ng-icon name="heroSparkles" size="18"></ng-icon>
                    Devenir Premium
                  }
                </button>

                <p class="plan-card__note">
                  Sans engagement - Annulez à tout moment
                </p>
              </div>
            }
          </div>
        }
      </section>

      <!-- Benefits Section -->
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">Les avantages Premium</h2>
        </div>

        <div class="benefits-grid">
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroVideoCamera" size="32"></ng-icon></div>
            <h4>Revisionnage illimité</h4>
            <p>Accédez aux enregistrements de tous vos cours passés pour réviser</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroPlayPause" size="32"></ng-icon></div>
            <h4>Reprise automatique</h4>
            <p>Reprenez le visionnage de vos cours où vous les avez laissés</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroBell" size="32"></ng-icon></div>
            <h4>Notifications prioritaires</h4>
            <p>Soyez alerté quand vos coachs favoris publient de nouveaux créneaux</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroPuzzlePiece" size="32"></ng-icon></div>
            <h4>Entraînement myChessBot</h4>
            <p>Exercez-vous contre notre IA après chaque cours pour progresser</p>
          </div>
        </div>
      </section>
    }

    <!-- Error Message -->
    <div class="alert-inline-container">
      <div class="alert-inline alert-inline--error" [class.alert-inline--visible]="paymentService.error()">
        <span>{{ paymentService.error() }}</span>
        <button class="alert__close" (click)="paymentService.clearError()">×</button>
      </div>
    </div>

  <!-- Embedded Checkout -->
  @if (showCheckout() && checkoutClientSecret()) {
    <app-embedded-checkout
      [clientSecret]="checkoutClientSecret()!"
      [title]="'Paiement - Abonnement Premium'"
      (closed)="closeCheckout()"
      (completed)="onCheckoutCompleted()"
    ></app-embedded-checkout>
  }
</div>
