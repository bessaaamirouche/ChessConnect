<div class="subscription-page">
    <header class="page-header">
      <div>
        <h1 class="page-header__title">{{ 'subscription.title' | translate }}</h1>
        <p class="page-header__subtitle">{{ 'subscription.subtitle' | translate }}</p>
      </div>
    </header>

    <!-- Active Free Trial Section -->
    @if (paymentService.hasActiveTrial() && !paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'subscription.trial.title' | translate }}</h2>
        </div>

        <div class="active-subscription-card active-subscription-card--trial">
          <div class="active-subscription-card__badge active-subscription-card__badge--trial">
            <ng-icon name="heroClock" size="16"></ng-icon>
            {{ 'subscription.trial.badge' | translate }}
          </div>
          <div class="active-subscription-card__content">
            <div class="active-subscription-card__plan">
              <span class="active-subscription-card__plan-icon"><ng-icon name="heroSparkles" size="32"></ng-icon></span>
              <div>
                <h3>{{ 'subscription.trial.planName' | translate }}</h3>
                <p class="active-subscription-card__price">
                  {{ 'subscription.trial.duration' | translate }}
                </p>
              </div>
            </div>

            <div class="active-subscription-card__trial-info">
              <ng-icon name="heroInformationCircle" size="18"></ng-icon>
              <span>
                {{ 'subscription.trial.daysRemaining' | translate: { days: paymentService.freeTrialStatus()?.daysRemaining } }}
                {{ 'subscription.trial.endsOn' | translate: { date: (paymentService.freeTrialStatus()?.trialEndDate | date:'dd/MM/yyyy') } }}
              </span>
            </div>

            <div class="active-subscription-card__row">
              <div class="active-subscription-card__features">
                <h4>{{ 'subscription.benefits.title' | translate }}</h4>
                <ul class="premium-features-list">
                  <li><ng-icon name="heroPlayCircle" size="18"></ng-icon> <strong>{{ 'subscription.benefits.replay' | translate }}</strong> {{ 'subscription.benefits.replayDesc' | translate }}</li>
                  <li><ng-icon name="heroArrowPath" size="18"></ng-icon> <strong>{{ 'subscription.benefits.resume' | translate }}</strong> {{ 'subscription.benefits.resumeDesc' | translate }}</li>
                  <li><ng-icon name="heroBellAlert" size="18"></ng-icon> <strong>{{ 'subscription.benefits.alerts' | translate }}</strong> {{ 'subscription.benefits.alertsDesc' | translate }}</li>
                  <li><ng-icon name="heroCpuChip" size="18"></ng-icon> <strong>{{ 'subscription.benefits.bot' | translate }}</strong> {{ 'subscription.benefits.botDesc' | translate }}</li>
                  <li><ng-icon name="heroSparkles" size="18"></ng-icon> <strong>{{ 'subscription.benefits.badge' | translate }}</strong> {{ 'subscription.benefits.badgeDesc' | translate }}</li>
                </ul>
              </div>
            </div>

            <div class="active-subscription-card__cta">
              <p class="text-muted">{{ 'subscription.trial.ctaMessage' | translate }}</p>
              @for (plan of paymentService.plans(); track plan.code) {
                <button
                  class="btn btn--primary btn--lg"
                  (click)="subscribeToPlan(plan.code)"
                  [disabled]="processingPlan() !== null"
                >
                  @if (processingPlan() === plan.code) {
                    <span class="spinner spinner--sm"></span>
                    {{ 'common.redirecting' | translate }}
                  } @else {
                    {{ 'subscription.upgrade' | translate }} - {{ formatPrice(plan.priceCents) }}{{ 'common.perMonth' | translate }}
                  }
                </button>
              }
            </div>
          </div>
        </div>
      </section>
    }

    <!-- Trial Success Message -->
    @if (trialSuccess()) {
      <div class="trial-success-banner">
        <ng-icon name="heroCheck" size="24"></ng-icon>
        <div>
          <strong>{{ 'subscription.trial.successTitle' | translate }}</strong>
          <p>{{ 'subscription.trial.successMessage' | translate }}</p>
        </div>
        <a routerLink="/teachers" class="btn btn--primary">{{ 'subscription.bookLesson' | translate }}</a>
      </div>
    }

    <!-- Active Subscription Section -->
    @if (paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">
            @if (paymentService.activeSubscription()!.cancelledAt) {
              {{ 'subscription.cancelled' | translate }}
            } @else {
              {{ 'subscription.active' | translate }}
            }
          </h2>
        </div>

        <div class="active-subscription-card" [class.active-subscription-card--cancelled]="paymentService.activeSubscription()!.cancelledAt">
          @if (paymentService.activeSubscription()!.cancelledAt) {
            <div class="active-subscription-card__badge active-subscription-card__badge--cancelled">{{ 'status.cancelled' | translate }}</div>
          } @else {
            <div class="active-subscription-card__badge active-subscription-card__badge--premium">
              <ng-icon name="heroSparkles" size="16"></ng-icon>
              {{ 'common.premium' | translate }}
            </div>
          }
          <div class="active-subscription-card__content">
            <div class="active-subscription-card__plan">
              <span class="active-subscription-card__plan-icon"><ng-icon name="heroTrophy" size="32"></ng-icon></span>
              <div>
                <h3>{{ paymentService.activeSubscription()!.planName || ('common.premium' | translate) }}</h3>
                <p class="active-subscription-card__price">
                  {{ formatPrice(paymentService.activeSubscription()!.priceCents) }}{{ 'common.perMonth' | translate }}
                </p>
              </div>
            </div>

            @if (paymentService.activeSubscription()!.cancelledAt && paymentService.activeSubscription()!.endDate) {
              <div class="active-subscription-card__cancelled-info">
                <ng-icon name="heroInformationCircle" size="18"></ng-icon>
                <span>{{ 'subscription.activeUntil' | translate: { date: (paymentService.activeSubscription()!.endDate | date:'dd/MM/yyyy') } }}</span>
              </div>
            }

            <div class="active-subscription-card__row">
              <div class="active-subscription-card__features">
                <h4>{{ 'subscription.benefits.title' | translate }}</h4>
                <ul class="premium-features-list">
                  <li><ng-icon name="heroPlayCircle" size="18"></ng-icon> <strong>{{ 'subscription.benefits.replay' | translate }}</strong> {{ 'subscription.benefits.replayDesc' | translate }}</li>
                  <li><ng-icon name="heroArrowPath" size="18"></ng-icon> <strong>{{ 'subscription.benefits.resume' | translate }}</strong> {{ 'subscription.benefits.resumeDesc' | translate }}</li>
                  <li><ng-icon name="heroBellAlert" size="18"></ng-icon> <strong>{{ 'subscription.benefits.alerts' | translate }}</strong> {{ 'subscription.benefits.alertsDesc' | translate }}</li>
                  <li><ng-icon name="heroCpuChip" size="18"></ng-icon> <strong>{{ 'subscription.benefits.bot' | translate }}</strong> {{ 'subscription.benefits.botDesc' | translate }}</li>
                  <li><ng-icon name="heroSparkles" size="18"></ng-icon> <strong>{{ 'subscription.benefits.badge' | translate }}</strong> {{ 'subscription.benefits.badgeDesc' | translate }}</li>
                </ul>
              </div>

              <div class="active-subscription-card__stats">
                <div class="stat-item">
                  <span class="stat-item__value">{{ paymentService.activeSubscription()!.startDate | date:'dd/MM/yyyy' }}</span>
                  <span class="stat-item__label">{{ 'subscription.memberSince' | translate }}</span>
                </div>
                @if (paymentService.activeSubscription()!.cancelledAt && paymentService.activeSubscription()!.endDate) {
                  <div class="stat-item">
                    <span class="stat-item__value">{{ paymentService.activeSubscription()!.endDate | date:'dd/MM/yyyy' }}</span>
                    <span class="stat-item__label">{{ 'subscription.expiresOn' | translate }}</span>
                  </div>
                }
              </div>
            </div>

            <div class="active-subscription-card__actions">
              <a routerLink="/teachers" class="btn btn--primary">{{ 'subscription.bookLesson' | translate }}</a>
              @if (!paymentService.activeSubscription()!.cancelledAt) {
                <button class="btn btn--ghost btn--danger" (click)="confirmCancel()">
                  {{ 'subscription.cancel' | translate }}
                </button>
              }
            </div>
          </div>
        </div>
      </section>
    }

    <!-- Cancel Confirmation Modal -->
    @if (showCancelConfirm()) {
      <div class="modal-overlay" (click)="dismissCancelConfirm()">
        <div class="modal" (click)="$event.stopPropagation()">
          <div class="modal__header">
            <h3>{{ 'subscription.cancelConfirm.title' | translate }}</h3>
          </div>
          <div class="modal__body">
            <p>{{ 'subscription.cancelConfirm.message' | translate }}</p>
            <p class="text-muted">{{ 'subscription.cancelConfirm.warning' | translate }}</p>
          </div>
          <div class="modal__footer">
            <button class="btn btn--ghost" (click)="dismissCancelConfirm()">{{ 'subscription.cancelConfirm.keep' | translate }}</button>
            <button
              class="btn btn--danger"
              (click)="cancelSubscription()"
              [disabled]="cancelling()"
            >
              @if (cancelling()) {
                <span class="spinner spinner--sm"></span>
                {{ 'subscription.cancelling' | translate }}
              } @else {
                {{ 'subscription.cancelConfirm.confirm' | translate }}
              }
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Plans Section -->
    @if (!paymentService.activeSubscription() && !paymentService.hasActiveTrial()) {
      <!-- Free Trial Banner (without card) -->
      @if (paymentService.canStartFreeTrial()) {
        <div class="trial-banner trial-banner--free">
          <div class="trial-banner__icon">
            <ng-icon name="heroSparkles" size="24"></ng-icon>
          </div>
          <div class="trial-banner__content">
            <strong>{{ 'subscription.trial.bannerTitle' | translate }}</strong>
            <p>{{ 'subscription.trial.bannerMessage' | translate }}</p>
          </div>
          <button
            class="btn btn--gold trial-banner__btn"
            (click)="startFreeTrial()"
            [disabled]="startingTrial()"
          >
            @if (startingTrial()) {
              <span class="spinner spinner--sm"></span>
              {{ 'subscription.trial.activating' | translate }}
            } @else {
              {{ 'subscription.trial.start' | translate }}
            }
          </button>
        </div>
      }

      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'subscription.upgrade' | translate }}</h2>
        </div>

        @if (paymentService.loading()) {
          <div class="loading-state">
            <span class="spinner spinner--lg"></span>
          </div>
        } @else {
          <div class="premium-plan-container">
            @for (plan of paymentService.plans(); track plan.code) {
              <div class="plan-card plan-card--premium">
                <div class="plan-card__badge plan-card__badge--gold">
                  <ng-icon name="heroSparkles" size="14"></ng-icon>
                  {{ 'subscription.recommended' | translate }}
                </div>

                <div class="plan-card__header">
                  <h3 class="plan-card__name">{{ plan.name }}</h3>
                  <div class="plan-card__price">
                    <span class="plan-card__price-amount">{{ formatPrice(plan.priceCents) }}</span>
                    <span class="plan-card__price-period">{{ 'common.perMonth' | translate }}</span>
                  </div>
                  <p class="plan-card__tagline">{{ 'subscription.allFeatures' | translate }}</p>
                </div>

                <ul class="plan-card__features">
                  @for (feature of plan.features; track feature) {
                    <li>
                      <ng-icon name="heroCheck" class="plan-card__feature-check"></ng-icon>
                      {{ feature }}
                    </li>
                  }
                </ul>

                <button
                  class="btn btn--primary btn--lg plan-card__btn"
                  (click)="subscribeToPlan(plan.code)"
                  [disabled]="processingPlan() !== null"
                >
                  @if (processingPlan() === plan.code) {
                    <span class="spinner spinner--sm"></span>
                    {{ 'common.redirecting' | translate }}
                  } @else {
                    <ng-icon name="heroSparkles" size="18"></ng-icon>
                    {{ 'subscription.becomePremium' | translate }}
                  }
                </button>

                <p class="plan-card__note">
                  {{ 'subscription.noCommitment' | translate }}
                </p>
              </div>
            }
          </div>
        }
      </section>

    }

    <!-- Benefits Section (visible for non-subscribers) -->
    @if (!paymentService.activeSubscription()) {
      <section class="section">
        <div class="section__header">
          <h2 class="section__title">{{ 'subscription.benefits.title' | translate }}</h2>
        </div>

        <div class="benefits-grid">
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroVideoCamera" size="32"></ng-icon></div>
            <h4>{{ 'subscription.benefitCards.replay.title' | translate }}</h4>
            <p>{{ 'subscription.benefitCards.replay.description' | translate }}</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroPlayPause" size="32"></ng-icon></div>
            <h4>{{ 'subscription.benefitCards.resume.title' | translate }}</h4>
            <p>{{ 'subscription.benefitCards.resume.description' | translate }}</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroBell" size="32"></ng-icon></div>
            <h4>{{ 'subscription.benefitCards.alerts.title' | translate }}</h4>
            <p>{{ 'subscription.benefitCards.alerts.description' | translate }}</p>
          </div>
          <div class="benefit-card">
            <div class="benefit-card__icon"><ng-icon name="heroPuzzlePiece" size="32"></ng-icon></div>
            <h4>{{ 'subscription.benefitCards.bot.title' | translate }}</h4>
            <p>{{ 'subscription.benefitCards.bot.description' | translate }}</p>
          </div>
        </div>
      </section>
    }

    <!-- Error Message -->
    <div class="alert-inline-container">
      <div class="alert-inline alert-inline--error" [class.alert-inline--visible]="paymentService.error()">
        <span>{{ paymentService.error() }}</span>
        <button class="alert__close" (click)="paymentService.clearError()">Ã—</button>
      </div>
    </div>

  <!-- Embedded Checkout -->
  @if (showCheckout() && checkoutClientSecret()) {
    <app-embedded-checkout
      [clientSecret]="checkoutClientSecret()!"
      [title]="'subscription.paymentTitle' | translate"
      (closed)="closeCheckout()"
      (completed)="onCheckoutCompleted()"
    ></app-embedded-checkout>
  }
</div>
