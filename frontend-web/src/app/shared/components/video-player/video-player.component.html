<div class="video-overlay" (click)="close.emit()">
  <div class="video-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="video-header">
      <div class="video-header__info">
        <h3>{{ title() }}</h3>
        @if (teacherName() || lessonDate()) {
          <p class="video-header__meta">
            @if (teacherName()) {
              <span>{{ teacherName() }}</span>
            }
            @if (teacherName() && lessonDate()) {
              <span class="separator">•</span>
            }
            @if (lessonDate()) {
              <span>{{ lessonDate() }}</span>
            }
          </p>
        }
      </div>
      <div class="video-header__actions">
        @if (downloadUrl()) {
          <button class="video-btn video-btn--icon" (click)="download()" [title]="'videoPlayer.download' | translate">
            <ng-icon name="heroArrowDownTray" size="20"></ng-icon>
          </button>
        }
        <button class="video-btn video-btn--icon video-btn--close" (click)="close.emit()" [title]="'common.close' | translate">
          <ng-icon name="heroXMark" size="24"></ng-icon>
        </button>
      </div>
    </div>

    <!-- Player Container -->
    <div
      #playerContainer
      class="video-container"
      [class.video-container--fullscreen]="isFullscreen()"
      (mousemove)="onMouseMove()"
      (touchstart)="onMouseMove()"
    >
      <!-- Mobile fullscreen exit button -->
      @if (isFullscreen()) {
        <button class="fullscreen-exit-btn" (click)="toggleFullscreen()" [title]="'videoPlayer.exitFullscreen' | translate">
          <ng-icon name="heroXMark" size="24"></ng-icon>
        </button>
      }
      <!-- Bunny Stream Embed -->
      @if (isBunnyStream() && bunnyEmbedUrl()) {
        <iframe
          [src]="bunnyEmbedUrl()"
          class="bunny-iframe"
          loading="lazy"
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
          allowfullscreen
        ></iframe>
      } @else {
        <!-- Native Video Player -->
        <video
          #videoElement
          class="video-element"
          playsinline
          (click)="togglePlay()"
        >
          {{ 'videoPlayer.notSupported' | translate }}
        </video>

        <!-- Loading Spinner -->
        @if (isLoading()) {
          <div class="video-loader">
            <div class="spinner spinner--lg"></div>
          </div>
        }

        <!-- Error State -->
        @if (hasError()) {
          <div class="video-error">
            <p>{{ 'videoPlayer.loadError' | translate }}</p>
            <button class="btn btn--primary btn--sm" (click)="close.emit()">{{ 'common.close' | translate }}</button>
          </div>
        }

        <!-- Play Button Overlay -->
        @if (!isPlaying() && !isLoading() && !hasError()) {
          <button class="video-play-overlay" (click)="togglePlay()">
            <div class="video-play-btn">
              <ng-icon name="heroPlaySolid" size="48"></ng-icon>
            </div>
            @if (savedProgressTime()) {
              <div class="video-resume-hint">
                {{ 'videoPlayer.resumeAt' | translate }} {{ formatTime(savedProgressTime()!) }}
              </div>
            }
          </button>
        }

        <!-- Controls -->
        <div class="video-controls" [class.video-controls--visible]="showControls() || !isPlaying()">
          <!-- Progress Bar -->
          <div class="video-progress" (click)="seek($event)">
            <div class="video-progress__track">
              <div class="video-progress__fill" [style.width.%]="progress()"></div>
            </div>
          </div>

          <!-- Control Buttons -->
          <div class="video-controls__row">
            <div class="video-controls__left">
              <!-- Play/Pause -->
              <button class="video-btn" (click)="togglePlay()" [title]="isPlaying() ? ('videoPlayer.pause' | translate) : ('videoPlayer.play' | translate)">
                <ng-icon [name]="isPlaying() ? 'heroPause' : 'heroPlay'" size="24"></ng-icon>
              </button>

              <!-- Skip Backward -->
              <button class="video-btn" (click)="skip(-10)" [title]="'videoPlayer.rewind' | translate">
                <ng-icon name="heroBackward" size="20"></ng-icon>
              </button>

              <!-- Skip Forward -->
              <button class="video-btn" (click)="skip(10)" [title]="'videoPlayer.forward' | translate">
                <ng-icon name="heroForward" size="20"></ng-icon>
              </button>

              <!-- Volume -->
              <div class="video-volume">
                <button class="video-btn" (click)="toggleMute()" [title]="isMuted() ? ('videoPlayer.unmute' | translate) : ('videoPlayer.mute' | translate)">
                  <ng-icon [name]="isMuted() ? 'heroSpeakerXMark' : 'heroSpeakerWave'" size="20"></ng-icon>
                </button>
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.1"
                  [value]="volume()"
                  (input)="setVolume($event)"
                  class="video-volume__slider"
                >
              </div>

              <!-- Time -->
              <div class="video-time">
                <span>{{ formattedCurrentTime() }}</span>
                <span class="separator">/</span>
                <span>{{ formattedDuration() }}</span>
              </div>
            </div>

            <div class="video-controls__right">
              <!-- Quality Selector -->
              <div class="video-quality">
                @if (availableQualities().length > 1) {
                  <button class="video-btn" (click)="toggleQualityMenu()" [title]="'videoPlayer.quality' | translate">
                    <ng-icon name="heroCog6Tooth" size="20"></ng-icon>
                    <span class="quality-label">{{ getQualityLabel() }}</span>
                  </button>
                  @if (showQualityMenu()) {
                    <div class="quality-menu">
                      <button
                        class="quality-option"
                        [class.active]="currentQuality() === -1"
                        (click)="setQuality(-1)"
                      >
                        {{ 'videoPlayer.auto' | translate }}
                      </button>
                      @for (quality of availableQualities(); track quality.index) {
                        <button
                          class="quality-option"
                          [class.active]="currentQuality() === quality.index"
                          (click)="setQuality(quality.index)"
                        >
                          {{ quality.label }}
                        </button>
                      }
                    </div>
                  }
                } @else {
                  <!-- Single quality (MP4) - just show indicator -->
                  <span class="quality-indicator" [title]="'videoPlayer.originalQuality' | translate">HD</span>
                }
              </div>

              <!-- Fullscreen -->
              <button class="video-btn" (click)="toggleFullscreen()" [title]="'videoPlayer.fullscreen' | translate">
                <ng-icon name="heroArrowsPointingOut" size="20"></ng-icon>
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Keyboard Shortcuts Hint -->
    @if (!isBunnyStream()) {
      <div class="video-hints">
        <span><kbd>{{ 'videoPlayer.shortcuts.space' | translate }}</kbd> {{ 'videoPlayer.shortcuts.playPause' | translate }}</span>
        <span><kbd>←</kbd><kbd>→</kbd> {{ 'videoPlayer.shortcuts.skip' | translate }}</span>
        <span><kbd>M</kbd> {{ 'videoPlayer.shortcuts.mute' | translate }}</span>
        <span><kbd>F</kbd> {{ 'videoPlayer.shortcuts.fullscreen' | translate }}</span>
      </div>
    }
  </div>
</div>
