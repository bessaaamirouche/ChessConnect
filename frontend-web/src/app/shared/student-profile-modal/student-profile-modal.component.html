<div class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal">
    <!-- Header -->
    <header class="modal__header">
      <h2 class="modal__title">{{ 'progress.studentProfile.title' | translate }}</h2>
      <button class="modal__close" (click)="closeModal()">
        <ng-icon name="heroXMark" size="24"></ng-icon>
      </button>
    </header>

    @if (learningPathService.loading()) {
      <div class="modal__loading">
        <span class="spinner spinner--lg"></span>
        <p>{{ 'progress.studentProfile.loading' | translate }}</p>
      </div>
    } @else if (learningPathService.studentProfile()) {
      <!-- Student Info -->
      <div class="student-info">
        <div class="student-info__avatar" [style.background-color]="getGradeColor(learningPathService.studentProfile()!.currentLevel)">
          {{ getGradeIcon(learningPathService.studentProfile()!.currentLevel) }}
        </div>
        <div class="student-info__details">
          <h3 class="student-info__name">{{ learningPathService.studentProfile()!.fullName }}</h3>
          <span class="student-info__level">
            {{ 'progress.studentProfile.level' | translate }} {{ learningPathService.studentProfile()!.currentLevelDisplayName }}
          </span>
        </div>
        <div class="student-info__stats">
          <div class="stat">
            <span class="stat__value">{{ learningPathService.studentProfile()!.totalLessonsCompleted }}</span>
            <span class="stat__label">{{ 'progress.studentProfile.validatedCourses' | translate }}</span>
          </div>
          <div class="stat">
            <span class="stat__value">{{ learningPathService.studentProfile()!.progressPercentage | number:'1.0-0' }}%</span>
            <span class="stat__label">{{ 'progress.studentProfile.progression' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Set Level Section -->
      <div class="level-section">
        <div class="level-section__header">
          <ng-icon name="heroAcademicCap" size="20"></ng-icon>
          <span>{{ 'progress.studentProfile.setLevel' | translate }}</span>
        </div>
        @if (learningPathService.studentProfile()!.levelSetByCoach && learningPathService.studentProfile()!.evaluatedByTeacherName) {
          <p class="level-section__info">
            {{ 'progress.studentProfile.levelSetBy' | translate }} <strong>{{ learningPathService.studentProfile()!.evaluatedByTeacherName }}</strong>
          </p>
        } @else {
          <p class="level-section__info level-section__info--warning">
            {{ 'progress.studentProfile.notEvaluated' | translate }}
          </p>
        }
        <div class="level-section__form">
          <select
            class="level-section__select"
            [value]="learningPathService.studentProfile()!.currentLevel"
            (change)="onLevelChange($event)"
          >
            @for (level of chessLevels; track level.value) {
              <option [value]="level.value">{{ level.icon }} {{ level.label }}</option>
            }
          </select>
          <button
            class="btn btn--primary"
            (click)="setLevel()"
            [disabled]="settingLevel()"
          >
            @if (settingLevel()) {
              <span class="spinner spinner--xs"></span>
            } @else {
              {{ 'common.apply' | translate }}
            }
          </button>
        </div>
      </div>

      <!-- Course Progress -->
      <div class="modal__content">
        <h4 class="section-title">{{ 'progress.studentProfile.progressByLevel' | translate }}</h4>

        <div class="grades-list">
          @for (grade of learningPathService.studentProfile()!.courseProgress; track grade.grade) {
            <div class="grade-card" [class.expanded]="isGradeExpanded(grade.grade)">
              <button class="grade-card__header" (click)="toggleGrade(grade.grade)">
                <span class="grade-card__icon" [style.color]="getGradeColor(grade.grade)">
                  {{ getGradeIcon(grade.grade) }}
                </span>
                <span class="grade-card__name">{{ grade.displayName }}</span>
                <span class="grade-card__progress">
                  {{ grade.completedCourses }}/{{ grade.totalCourses }}
                </span>
                <ng-icon [name]="isGradeExpanded(grade.grade) ? 'heroChevronUp' : 'heroChevronDown'" class="grade-card__chevron"></ng-icon>
              </button>

              @if (isGradeExpanded(grade.grade)) {
                <div class="grade-card__courses">
                  @for (course of grade.courses; track course.id) {
                    <div class="course-row" [class.course-row--completed]="course.status === 'COMPLETED'">
                      <span class="course-row__order">{{ course.orderInGrade }}.</span>
                      <span class="course-row__title">{{ course.title }}</span>

                      <div class="course-row__actions">
                        @switch (course.status) {
                          @case ('COMPLETED') {
                            <span class="course-row__status course-row__status--completed">
                              <ng-icon name="heroCheckCircle" size="18"></ng-icon>
                              {{ 'progress.studentProfile.validated' | translate }}
                            </span>
                          }
                          @case ('IN_PROGRESS') {
                            <button
                              class="btn btn--sm btn--primary"
                              (click)="validateCourse(course)"
                              [disabled]="validatingCourse() === course.id"
                            >
                              @if (validatingCourse() === course.id) {
                                <span class="spinner spinner--xs"></span>
                              } @else {
                                {{ 'progress.studentProfile.validate' | translate }}
                              }
                            </button>
                          }
                          @case ('PENDING_VALIDATION') {
                            <button
                              class="btn btn--sm btn--warning"
                              (click)="validateCourse(course)"
                              [disabled]="validatingCourse() === course.id"
                            >
                              @if (validatingCourse() === course.id) {
                                <span class="spinner spinner--xs"></span>
                              } @else {
                                {{ 'progress.studentProfile.pendingValidate' | translate }}
                              }
                            </button>
                          }
                          @case ('LOCKED') {
                            <span class="course-row__status course-row__status--locked">
                              <ng-icon name="heroLockClosed" size="16"></ng-icon>
                              {{ 'progress.locked' | translate }}
                            </span>
                          }
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    } @else if (learningPathService.error()) {
      <div class="modal__error">
        <p>{{ learningPathService.error() }}</p>
        <button class="btn btn--primary" (click)="learningPathService.getStudentProfile(studentId).subscribe()">
          {{ 'common.retry' | translate }}
        </button>
      </div>
    }

    <!-- Footer -->
    <footer class="modal__footer">
      <button class="btn btn--ghost" (click)="closeModal()">{{ 'common.close' | translate }}</button>
    </footer>
  </div>
</div>
