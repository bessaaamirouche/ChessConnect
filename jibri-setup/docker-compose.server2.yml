# Jibri Pool - Server 2 (164.68.125.196 / vmi3059346)
# 5 instances for parallel recording
# Server: 23 GB RAM / 8 CPU cores AMD EPYC
# ArabicConnect uses ~800 MB RAM / ~1 core
# Each Jibri instance: ~2.5 GB RAM (2 GB shm + Chrome/FFmpeg) + ~1.5 CPU cores
# Max capacity: 5 concurrent recorded lessons

x-jibri-defaults: &jibri-defaults
  build:
    context: .
    dockerfile: Dockerfile.remote
  restart: unless-stopped
  volumes:
    - /var/jibri/recordings:/config/recordings
    - ./finalize-remote.sh:/config/finalize.sh:ro
    - /root/.ssh:/root/.ssh:ro
  cap_add:
    - SYS_ADMIN
  shm_size: '2gb'
  network_mode: host

x-jibri-env: &jibri-env
  XMPP_AUTH_DOMAIN: auth.meet.mychess.fr
  XMPP_INTERNAL_MUC_DOMAIN: internal.auth.meet.mychess.fr
  XMPP_RECORDER_DOMAIN: recorder.meet.mychess.fr
  XMPP_SERVER: meet.mychess.fr
  XMPP_PORT: '5222'
  JIBRI_XMPP_USER: jibri
  JIBRI_XMPP_PASSWORD: ${JIBRI_XMPP_PASSWORD:-CHANGE_ME_SECURE_PASSWORD}
  JIBRI_RECORDER_USER: recorder
  JIBRI_RECORDER_PASSWORD: ${JIBRI_RECORDER_PASSWORD:-CHANGE_ME_SECURE_PASSWORD}
  JIBRI_BREWERY_MUC: jibribrewery
  JIBRI_RECORDING_DIR: /config/recordings
  JIBRI_FINALIZE_RECORDING_SCRIPT_PATH: /config/finalize.sh
  JIBRI_STRIP_DOMAIN_FROM_ROOM_NAME: 'false'
  TZ: Europe/Paris
  JIBRI_RECORDING_RESOLUTION: 1280x720
  JIBRI_RECORDING_CONSTANT_RATE_FACTOR: '20'
  JIBRI_RECORDING_VIDEO_ENCODE_PRESET_RECORDING: fast
  JIBRI_RECORDING_FRAMERATE: '25'
  JIBRI_USAGE_TIMEOUT: '0'
  MAIN_SERVER_IP: 5.189.173.131

services:
  jibri-4:
    <<: *jibri-defaults
    container_name: jibri-4
    environment:
      <<: *jibri-env
      JIBRI_INSTANCE_ID: jibri-4
      DISPLAY: ':0'

  jibri-5:
    <<: *jibri-defaults
    container_name: jibri-5
    environment:
      <<: *jibri-env
      JIBRI_INSTANCE_ID: jibri-5
      DISPLAY: ':1'

  jibri-6:
    <<: *jibri-defaults
    container_name: jibri-6
    environment:
      <<: *jibri-env
      JIBRI_INSTANCE_ID: jibri-6
      DISPLAY: ':2'

  jibri-7:
    <<: *jibri-defaults
    container_name: jibri-7
    environment:
      <<: *jibri-env
      JIBRI_INSTANCE_ID: jibri-7
      DISPLAY: ':3'

  jibri-8:
    <<: *jibri-defaults
    container_name: jibri-8
    environment:
      <<: *jibri-env
      JIBRI_INSTANCE_ID: jibri-8
      DISPLAY: ':4'
