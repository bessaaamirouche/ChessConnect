# Nginx Configuration for Serving Jibri Recordings
# Add this to /etc/nginx/sites-available/meet.mychess.fr
# inside the main server { } block

# Serve recorded video files
location /recordings/ {
    alias /var/jibri/recordings/;

    # Allow directory listing for debugging (disable in production)
    # autoindex on;

    # Handle MP4 files specifically
    location ~ \.mp4$ {
        # Set correct content type
        add_header Content-Type video/mp4;

        # Enable byte-range requests for video seeking
        add_header Accept-Ranges bytes;

        # Cache control - private to prevent CDN caching of private videos
        add_header Cache-Control "private, max-age=3600";

        # CORS - only allow from your frontend domain
        add_header Access-Control-Allow-Origin "https://mychess.fr";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Range";

        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://mychess.fr";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Range";
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }
    }

    # Deny access to other file types for security
    location ~ \.(sh|log|txt)$ {
        deny all;
    }
}
